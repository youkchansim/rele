# iOS ë°°í¬ ì›Œí¬í”Œë¡œìš°
#
# ì‚¬ìš©ë²•:
#   1. ì´ íŒŒì¼ì„ í”„ë¡œì íŠ¸ì˜ .github/workflows/ios-deploy.ymlë¡œ ë³µì‚¬
#   2. GitHub Secrets ì„¤ì • (ì•„ëž˜ ì°¸ê³ )
#   3. ìˆ˜ë™ ì‹¤í–‰ ë˜ëŠ” íƒœê·¸ í‘¸ì‹œë¡œ ë°°í¬
#
# í•„ìš”í•œ GitHub Secrets:
#   APP_STORE_CONNECT_API_KEY_ID     - API Key ID
#   APP_STORE_CONNECT_API_ISSUER_ID  - Issuer ID
#   APP_STORE_CONNECT_API_KEY_BASE64 - .p8 íŒŒì¼ì„ Base64 ì¸ì½”ë”©í•œ ê°’
#   MATCH_PASSWORD                   - (ì„ íƒ) Match ì•”í˜¸
#   MATCH_GIT_URL                    - (ì„ íƒ) Match ì €ìž¥ì†Œ URL
#
# Base64 ì¸ì½”ë”© ë°©ë²•:
#   base64 -i AuthKey_XXXXXX.p8 | pbcopy

name: iOS Deploy

on:
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      lane:
        description: 'ë°°í¬ íƒ€ìž…'
        required: true
        default: 'beta'
        type: choice
        options:
          - beta
          - release
      release_notes:
        description: 'ë¦´ë¦¬ì¦ˆë…¸íŠ¸ (ì„ íƒì‚¬í•­)'
        required: false
        type: string

  # íƒœê·¸ í‘¸ì‹œ ì‹œ ìžë™ ë°°í¬
  push:
    tags:
      - 'v*'           # v1.0.0 â†’ App Store ë°°í¬
      - 'beta-*'       # beta-* â†’ TestFlight ë°°í¬

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: ios-deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ”§ í”„ë¡œì íŠ¸ ì„¤ì • (ìˆ˜ì • í•„ìš”)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  XCODE_PROJECT: "YourApp.xcodeproj"
  SCHEME: "YourApp"
  BUNDLE_ID: "com.yourcompany.app"

  # Xcode ë²„ì „ (ì„ íƒì‚¬í•­ - ê¸°ë³¸ê°’: latest)
  # XCODE_VERSION: "15.0"

jobs:
  build-and-deploy:
    name: Build & Deploy
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ðŸ“¥ ì²´í¬ì•„ì›ƒ & í™˜ê²½ ì„¤ì •
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ (ë²„ì „ íƒœê·¸ìš©)

      - name: Select Xcode version
        run: |
          if [ -n "${{ env.XCODE_VERSION }}" ]; then
            sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          fi
          xcodebuild -version
          swift --version

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true  # Gemfile.lock ìºì‹±

      - name: Install Fastlane
        run: |
          if [ -f "Gemfile" ]; then
            bundle install
          else
            gem install fastlane
          fi

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ðŸ” ì¸ì¦ ì„¤ì •
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Setup App Store Connect API Key
        run: |
          mkdir -p ~/.appstore_keys

          # Base64 ë””ì½”ë”©í•˜ì—¬ .p8 íŒŒì¼ ìƒì„±
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}" | base64 --decode > ~/.appstore_keys/AuthKey.p8

          # config.json ìƒì„±
          cat > ~/.appstore_keys/config.json << EOF
          {
            "default": {
              "key_id": "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}",
              "issuer_id": "${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}",
              "key_file": "AuthKey.p8"
            }
          }
          EOF

      - name: Setup Keychain
        run: |
          # ìž„ì‹œ í‚¤ì²´ì¸ ìƒì„± (CI í™˜ê²½ìš©)
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # ì½”ë“œ ì„œëª… ê¶Œí•œ í—ˆìš©
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ðŸ“¦ ì˜ì¡´ì„± ìºì‹±
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
            .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve SPM dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project "${{ env.XCODE_PROJECT }}" \
            -scheme "${{ env.SCHEME }}"

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ðŸš€ ë°°í¬ ì‹¤í–‰
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Determine deployment type
        id: deploy-type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "lane=${{ github.event.inputs.lane }}" >> $GITHUB_OUTPUT
            echo "notes=${{ github.event.inputs.release_notes }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            echo "lane=release" >> $GITHUB_OUTPUT
            echo "notes=" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/beta-* ]]; then
            echo "lane=beta" >> $GITHUB_OUTPUT
            echo "notes=" >> $GITHUB_OUTPUT
          else
            echo "lane=beta" >> $GITHUB_OUTPUT
            echo "notes=" >> $GITHUB_OUTPUT
          fi

      - name: Run Fastlane
        run: |
          LANE="${{ steps.deploy-type.outputs.lane }}"
          NOTES="${{ steps.deploy-type.outputs.notes }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸš€ ë°°í¬ ì‹œìž‘"
          echo "   Lane: $LANE"
          echo "   Notes: ${NOTES:-'(ê¸°ë³¸ê°’ ì‚¬ìš©)'}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ -n "$NOTES" ]; then
            bundle exec fastlane "$LANE" notes:"$NOTES"
          else
            bundle exec fastlane "$LANE"
          fi

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ipa-${{ github.run_number }}
          path: build/*.ipa
          retention-days: 7

      - name: Upload dSYM artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dsym-${{ github.run_number }}
          path: build/*.dSYM.zip
          retention-days: 30

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ðŸ§¹ ì •ë¦¬
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Cleanup secrets
        if: always()
        run: |
          rm -rf ~/.appstore_keys
          security delete-keychain build.keychain 2>/dev/null || true

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ðŸ“¢ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Summary
        if: success()
        run: |
          echo "## âœ… ë°°í¬ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ë°°í¬ íƒ€ìž… | ${{ steps.deploy-type.outputs.lane }} |" >> $GITHUB_STEP_SUMMARY
          echo "| íŠ¸ë¦¬ê±° | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì»¤ë°‹ | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì‹¤í–‰ ë²ˆí˜¸ | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY

      - name: Failure Summary
        if: failure()
        run: |
          echo "## âŒ ë°°í¬ ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
