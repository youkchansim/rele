# iOS í…ŒìŠ¤íŠ¸ ì›Œí¬í”Œë¡œìš°
#
# PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ ìžë™ìœ¼ë¡œ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
# ë©”ì¸ ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œì—ë„ ì‹¤í–‰

name: iOS Test

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**/*.swift'
      - '**/*.xcodeproj/**'
      - '**/*.xcworkspace/**'
      - '**/Package.swift'
      - '**/Package.resolved'
      - '.github/workflows/ios-test.yml'

  push:
    branches: [main, develop]
    paths:
      - '**/*.swift'
      - '**/*.xcodeproj/**'
      - '**/*.xcworkspace/**'
      - '**/Package.swift'
      - '**/Package.resolved'

# ë™ì¼ PRì˜ ì´ì „ ì‹¤í–‰ ì·¨ì†Œ
concurrency:
  group: ios-test-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ”§ í”„ë¡œì íŠ¸ ì„¤ì • (ìˆ˜ì • í•„ìš”)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  XCODE_PROJECT: "YourApp.xcodeproj"
  SCHEME: "YourApp"
  TEST_DESTINATION: "platform=iOS Simulator,name=iPhone 15,OS=latest"

jobs:
  build-and-test:
    name: Build & Test
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          xcodebuild -version
          swift --version

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ðŸ“¦ ìºì‹±
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Cache SPM dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
            .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-derived-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-derived-

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ðŸ”¨ ë¹Œë“œ & í…ŒìŠ¤íŠ¸
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Resolve dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project "${{ env.XCODE_PROJECT }}" \
            -scheme "${{ env.SCHEME }}"

      - name: Build for testing
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project "${{ env.XCODE_PROJECT }}" \
            -scheme "${{ env.SCHEME }}" \
            -destination "${{ env.TEST_DESTINATION }}" \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty --color

      - name: Run tests
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project "${{ env.XCODE_PROJECT }}" \
            -scheme "${{ env.SCHEME }}" \
            -destination "${{ env.TEST_DESTINATION }}" \
            -resultBundlePath TestResults.xcresult \
            | xcpretty --color --report junit --output test-results.xml

      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # ðŸ“Š ê²°ê³¼ ë¦¬í¬íŠ¸
      # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            TestResults.xcresult
            test-results.xml
          retention-days: 7

      - name: Test Summary
        if: always()
        run: |
          if [ -f "test-results.xml" ]; then
            echo "## í…ŒìŠ¤íŠ¸ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            # XMLì—ì„œ í…ŒìŠ¤íŠ¸ ìˆ˜ ì¶”ì¶œ (ê°„ë‹¨í•œ ë²„ì „)
            TESTS=$(grep -o 'tests="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*' || echo "0")
            FAILURES=$(grep -o 'failures="[0-9]*"' test-results.xml | head -1 | grep -o '[0-9]*' || echo "0")
            echo "- ì´ í…ŒìŠ¤íŠ¸: $TESTS" >> $GITHUB_STEP_SUMMARY
            echo "- ì‹¤íŒ¨: $FAILURES" >> $GITHUB_STEP_SUMMARY
          fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ðŸ” SwiftLint (ì„ íƒì‚¬í•­)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  lint:
    name: SwiftLint
    runs-on: macos-14
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run SwiftLint
        run: |
          if command -v swiftlint &> /dev/null; then
            swiftlint lint --reporter github-actions-logging
          elif [ -f ".swiftlint.yml" ]; then
            brew install swiftlint
            swiftlint lint --reporter github-actions-logging
          else
            echo "SwiftLint not configured, skipping..."
          fi
