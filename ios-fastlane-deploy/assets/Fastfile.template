# Fastfile Template for iOS App Store Deployment
# ë²„ì „ í˜•ì‹: MAJOR.YEAR.MMDDNNN (ChatGPT ìŠ¤íƒ€ì¼)
#
# ì‚¬ìš©ë²•:
#   1. ì´ íŒŒì¼ì„ í”„ë¡œì íŠ¸ì˜ fastlane/Fastfileë¡œ ë³µì‚¬
#   2. PROJECT, SCHEME, MAJOR_VERSION ìˆ˜ì •
#   3. API í‚¤ ì •ë³´ ì…ë ¥ (key_id, issuer_id, key_filepath)
#
# ëª…ë ¹ì–´:
#   fastlane release                    - App Store ë°°í¬ (ê¸°ë³¸ ë¦´ë¦¬ì¦ˆë…¸íŠ¸)
#   fastlane release notes:"ì»¤ìŠ¤í…€ ë…¸íŠ¸" - App Store ë°°í¬ (ì»¤ìŠ¤í…€ ë¦´ë¦¬ì¦ˆë…¸íŠ¸)
#   fastlane beta                       - TestFlight ë°°í¬
#   fastlane build_only                 - ë¹Œë“œë§Œ
#
# ì˜µì…˜:
#   skip_commit:true  - ë²„ì „ ë³€ê²½ ì»¤ë°‹ ê±´ë„ˆë›°ê¸° (CI í™˜ê²½ì—ì„œ ìœ ìš©)
#
# ë¦´ë¦¬ì¦ˆë…¸íŠ¸ ì˜µì…˜:
#   1. íŒŒë¼ë¯¸í„° ì—†ìŒ: ê¸°ë³¸ê°’ ì‚¬ìš© ("ì•ˆì •ì„±ì„ ê°œì„ í•˜ì˜€ì–´ìš”")
#   2. notes:"í…ìŠ¤íŠ¸": ì§ì ‘ ì§€ì •
#   3. fastlane/release_notes.txt íŒŒì¼ì´ ìˆìœ¼ë©´ í•´ë‹¹ ë‚´ìš© ì‚¬ìš©

default_platform(:ios)

platform :ios do

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ”§ í”„ë¡œì íŠ¸ ì„¤ì • (ìˆ˜ì • í•„ìš”)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  PROJECT = "YourApp.xcodeproj"     # Xcode í”„ë¡œì íŠ¸ íŒŒì¼ëª…
  SCHEME = "YourApp"                 # ë¹Œë“œ Scheme ì´ë¦„
  BUNDLE_ID = "com.yourcompany.app"  # Bundle Identifier
  MAJOR_VERSION = "1"                # ë©”ì´ì € ë²„ì „ (í° ë³€ê²½ ì‹œ ìˆ˜ë™ ì¦ê°€)

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ” App Store Connect API í‚¤ ì„¤ì •
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ê³µìš© í‚¤ ìœ„ì¹˜: ~/.appstore_keys/
  # í”„ë¡œì íŠ¸ë³„ í‚¤ê°€ í•„ìš”í•˜ë©´ fastlane/AuthKey_*.p8 ì‚¬ìš©

  GLOBAL_CONFIG_DIR = File.expand_path("~/.appstore_keys")
  GLOBAL_CONFIG_PATH = "#{GLOBAL_CONFIG_DIR}/config.json"

  # ê³µìš© ì„¤ì • ë¡œë“œ
  def load_global_config
    if File.exist?(GLOBAL_CONFIG_PATH)
      require 'json'
      JSON.parse(File.read(GLOBAL_CONFIG_PATH))
    else
      nil
    end
  end

  # API í‚¤ ê²½ë¡œ ê²°ì • (í”„ë¡œì íŠ¸ ë¡œì»¬ â†’ ê³µìš© ìœ„ì¹˜)
  def find_api_key_path(config)
    local_key = Dir.glob("fastlane/AuthKey_*.p8").first
    return local_key if local_key

    if config && config.dig("default", "key_file")
      global_key = "#{GLOBAL_CONFIG_DIR}/#{config.dig("default", "key_file")}"
      return global_key if File.exist?(global_key)
    end

    nil
  end

  # ì„¤ì • ê²€ì¦ ë° ì—ëŸ¬ í‘œì‹œ
  def validate_api_config!
    config = load_global_config
    key_path = find_api_key_path(config)

    if config.nil? || key_path.nil?
      puts ""
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts "âŒ App Store Connect API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts ""
      puts "ğŸ“ ì„¤ì • ë°©ë²•:"
      puts ""
      puts "1. ë””ë ‰í† ë¦¬ ìƒì„±:"
      puts "   mkdir -p ~/.appstore_keys"
      puts ""
      puts "2. API í‚¤ íŒŒì¼ ë³µì‚¬ (.p8 íŒŒì¼):"
      puts "   cp /path/to/AuthKey_XXXXXX.p8 ~/.appstore_keys/"
      puts ""
      puts "3. config.json ìƒì„±:"
      puts "   cat > ~/.appstore_keys/config.json << 'EOF'"
      puts '   {'
      puts '     "default": {'
      puts '       "key_id": "YOUR_KEY_ID",'
      puts '       "issuer_id": "YOUR_ISSUER_ID",'
      puts '       "key_file": "AuthKey_XXXXXX.p8"'
      puts '     },'
      puts '     "apple_id": "your-email@example.com",'
      puts '     "team_id": "XXXXXXXXXX"'
      puts '   }'
      puts "   EOF"
      puts ""
      puts "ğŸ“Œ API í‚¤ ë°œê¸‰ ë°©ë²•:"
      puts "   1. https://appstoreconnect.apple.com ì ‘ì†"
      puts "   2. Users and Access â†’ Keys â†’ App Store Connect API"
      puts "   3. + ë²„íŠ¼ìœ¼ë¡œ ìƒˆ í‚¤ ìƒì„± (Admin ê¶Œí•œ)"
      puts "   4. Key ID, Issuer ID ë³µì‚¬"
      puts "   5. .p8 íŒŒì¼ ë‹¤ìš´ë¡œë“œ"
      puts ""
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      UI.user_error!("API í‚¤ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. ìœ„ ê°€ì´ë“œë¥¼ ì°¸ê³ í•˜ì„¸ìš”.")
    end

    { config: config, key_path: key_path }
  end

  # ì„¤ì • ê²€ì¦
  API_CONFIG = validate_api_config!
  GLOBAL_CONFIG = API_CONFIG[:config]

  API_KEY = app_store_connect_api_key(
    key_id: GLOBAL_CONFIG.dig("default", "key_id"),
    issuer_id: GLOBAL_CONFIG.dig("default", "issuer_id"),
    key_filepath: API_CONFIG[:key_path]
  )

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“Œ ë²„ì „ ìë™ ìƒì„± (ChatGPT ìŠ¤íƒ€ì¼: MAJOR.YEAR.MMDDNNN)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "ìë™ ë²„ì „ ìƒì„±"
  private_lane :generate_version do
    now = Time.now
    year = now.strftime("%Y")
    mmdd = now.strftime("%m%d")

    current_version = get_version_number(
      xcodeproj: PROJECT,
      target: SCHEME
    )

    today_pattern = "#{MAJOR_VERSION}.#{year}.#{mmdd}"

    if current_version.start_with?(today_pattern)
      last_three = current_version[-3..-1].to_i
      serial = format("%03d", last_three + 1)
    else
      serial = "001"
    end

    new_version = "#{today_pattern}#{serial}"
    new_build = "#{year}#{mmdd}#{serial}"

    { version: new_version, build: new_build }
  end

  desc "ë²„ì „ ì—…ë°ì´íŠ¸ ì ìš©"
  private_lane :apply_version do |options|
    version_info = options[:version_info]

    increment_version_number(
      xcodeproj: PROJECT,
      version_number: version_info[:version]
    )

    increment_build_number(
      xcodeproj: PROJECT,
      build_number: version_info[:build]
    )

    puts "ğŸ“Œ ë²„ì „ ì—…ë°ì´íŠ¸: #{version_info[:version]} (#{version_info[:build]})"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“ ë²„ì „ ë³€ê²½ ìë™ ì»¤ë°‹
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "ë²„ì „ ë³€ê²½ ì‚¬í•­ì„ Gitì— ì»¤ë°‹"
  private_lane :commit_version do |options|
    version = options[:version]
    skip_commit = options[:skip_commit] || false

    # CI í™˜ê²½ì´ê±°ë‚˜ skip_commit ì˜µì…˜ì´ ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
    if skip_commit || ENV['CI'] == 'true'
      puts "â­ï¸  ë²„ì „ ì»¤ë°‹ ê±´ë„ˆëœ€ (CI í™˜ê²½ ë˜ëŠ” skip_commit ì˜µì…˜)"
      next
    end

    # Git ì €ì¥ì†Œì¸ì§€ í™•ì¸
    unless File.directory?(".git")
      puts "âš ï¸  Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤. ì»¤ë°‹ ê±´ë„ˆëœ€."
      next
    end

    # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
    changed_files = sh("git diff --name-only", log: false).strip
    if changed_files.empty?
      puts "â„¹ï¸  ë³€ê²½ëœ íŒŒì¼ ì—†ìŒ"
      next
    end

    # project.pbxproj íŒŒì¼ë§Œ ì»¤ë°‹ (ë²„ì „ ë³€ê²½)
    project_file = "#{PROJECT}/project.pbxproj"
    if changed_files.include?("project.pbxproj")
      git_add(path: project_file)
      git_commit(
        path: project_file,
        message: "chore: bump version to #{version}",
        allow_nothing_to_commit: true
      )
      puts "âœ… ë²„ì „ ë³€ê²½ ì»¤ë°‹ ì™„ë£Œ: #{version}"
    end
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“ ë¦´ë¦¬ì¦ˆë…¸íŠ¸ ìƒì„±
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ìš°ì„ ìˆœìœ„:
  #   1. íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ëœ notes
  #   2. fastlane/release_notes.txt íŒŒì¼
  #   3. ê¸°ë³¸ê°’
  desc "ë¦´ë¦¬ì¦ˆë…¸íŠ¸ ê°€ì ¸ì˜¤ê¸°"
  private_lane :get_release_notes do |options|
    custom_notes = options[:notes]
    notes_file = "fastlane/release_notes.txt"

    # ê¸°ë³¸ ë¦´ë¦¬ì¦ˆë…¸íŠ¸
    default_notes = {
      "en-US" => "Improved stability and performance.",
      "ko" => "ì•ˆì •ì„±ì„ ê°œì„ í•˜ì˜€ì–´ìš”."
    }

    if custom_notes && !custom_notes.empty?
      # 1. íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ëœ ë…¸íŠ¸ ì‚¬ìš©
      puts "ğŸ“ ë¦´ë¦¬ì¦ˆë…¸íŠ¸: ì»¤ìŠ¤í…€ (íŒŒë¼ë¯¸í„°)"
      {
        "default" => custom_notes,
        "en-US" => custom_notes,
        "ko" => custom_notes
      }
    elsif File.exist?(notes_file)
      # 2. íŒŒì¼ì—ì„œ ì½ê¸°
      content = File.read(notes_file).strip
      puts "ğŸ“ ë¦´ë¦¬ì¦ˆë…¸íŠ¸: íŒŒì¼ (#{notes_file})"

      # íŒŒì¼ í˜•ì‹ íŒŒì‹± (ì–¸ì–´ë³„ êµ¬ë¶„ ì§€ì›)
      # í˜•ì‹:
      # [ko]
      # í•œêµ­ì–´ ë…¸íŠ¸
      # [en-US]
      # English notes
      if content.include?("[ko]") || content.include?("[en-US]")
        notes = { "default" => "" }
        current_lang = "default"

        content.each_line do |line|
          line = line.strip
          if line.match(/^\[(.+)\]$/)
            current_lang = $1
            notes[current_lang] ||= ""
          elsif !line.empty?
            notes[current_lang] += (notes[current_lang].empty? ? "" : "\n") + line
          end
        end

        notes["default"] = notes["ko"] || notes["en-US"] || content
        notes
      else
        # ë‹¨ì¼ ì–¸ì–´ (í•œêµ­ì–´ë¡œ ê°„ì£¼)
        {
          "default" => content,
          "en-US" => content,
          "ko" => content
        }
      end
    else
      # 3. ê¸°ë³¸ê°’ ì‚¬ìš©
      puts "ğŸ“ ë¦´ë¦¬ì¦ˆë…¸íŠ¸: ê¸°ë³¸ê°’"
      {
        "default" => default_notes["ko"],
        "en-US" => default_notes["en-US"],
        "ko" => default_notes["ko"]
      }
    end
  end

  before_all do
    # Git ìƒíƒœ í™•ì¸ (í•„ìš” ì‹œ í™œì„±í™”)
    # ensure_git_status_clean
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸš€ App Store ë°°í¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "App Store ë°°í¬ (ì‹¬ì‚¬ ì œì¶œ í¬í•¨)"
  desc "ì‚¬ìš©ë²•: fastlane release [notes:'ë¦´ë¦¬ì¦ˆë…¸íŠ¸']"
  lane :release do |options|
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    # ë¦´ë¦¬ì¦ˆë…¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
    release_notes = get_release_notes(notes: options[:notes])

    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¦ App Store ë°°í¬ ì‹œì‘"
    puts "   ë²„ì „: #{version}"
    puts "   ë¹Œë“œ: #{build_number}"
    puts "   ë¦´ë¦¬ì¦ˆë…¸íŠ¸ (ko): #{release_notes['ko']&.slice(0, 50)}..."
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    puts "âœ… ë¹Œë“œ ì™„ë£Œ: ./build/#{SCHEME}.ipa"

    upload_to_app_store(
      api_key: API_KEY,
      skip_metadata: false,
      skip_screenshots: false,
      skip_binary_upload: false,
      force: true,
      submit_for_review: true,
      automatic_release: true,
      run_precheck_before_submit: false,  # IAP ì•±ì—ì„œ precheck ì˜¤ë¥˜ ë°©ì§€
      submission_information: {
        add_id_info_uses_idfa: false
      },
      release_notes: release_notes
    )

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… App Store ë°°í¬ ì™„ë£Œ!"
    puts "   ë²„ì „: #{version} (#{build_number})"
    puts "   ìƒíƒœ: ì‹¬ì‚¬ ëŒ€ê¸° ì¤‘"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # ë¦´ë¦¬ì¦ˆë…¸íŠ¸ íŒŒì¼ ì •ë¦¬ (ì‚¬ìš© í›„ ì‚­ì œ)
    notes_file = "fastlane/release_notes.txt"
    if File.exist?(notes_file)
      File.delete(notes_file)
      puts "ğŸ—‘ï¸  ë¦´ë¦¬ì¦ˆë…¸íŠ¸ íŒŒì¼ ì‚­ì œë¨"
    end

    # ë²„ì „ ë³€ê²½ ìë™ ì»¤ë°‹
    commit_version(version: version, skip_commit: options[:skip_commit])
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ§ª TestFlight ë² íƒ€ ë°°í¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "TestFlight ë² íƒ€ ë°°í¬"
  desc "ì‚¬ìš©ë²•: fastlane beta [skip_commit:true]"
  lane :beta do |options|
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    puts "ğŸ§ª TestFlight ë°°í¬: #{version} (#{build_number})"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    upload_to_testflight(
      api_key: API_KEY,
      skip_waiting_for_build_processing: true
    )

    puts "âœ… TestFlight ì—…ë¡œë“œ ì™„ë£Œ!"

    # ë²„ì „ ë³€ê²½ ìë™ ì»¤ë°‹
    commit_version(version: version, skip_commit: options[:skip_commit])
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“¥ ë©”íƒ€ë°ì´í„° ë™ê¸°í™”
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "App Store Connectì—ì„œ ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ"
  desc "ì‚¬ìš©ë²•: fastlane sync_metadata"
  lane :sync_metadata do
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¥ ë©”íƒ€ë°ì´í„° ë™ê¸°í™” ì‹œì‘"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # ê³µìš© API í‚¤ ê²½ë¡œ (deliverìš© JSON í˜•ì‹)
    global_api_key_json = "#{GLOBAL_CONFIG_DIR}/api_key.json"

    # deliver initìœ¼ë¡œ ë©”íƒ€ë°ì´í„° + ìŠ¤í¬ë¦°ìƒ· ëª¨ë‘ ë‹¤ìš´ë¡œë“œ
    puts "\nğŸ“ ë©”íƒ€ë°ì´í„° & ìŠ¤í¬ë¦°ìƒ· ë‹¤ìš´ë¡œë“œ ì¤‘..."
    sh("fastlane deliver init --app_identifier '#{BUNDLE_ID}' --api_key_path '#{global_api_key_json}' --use_live_version true")

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… ë©”íƒ€ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ!"
    puts "   - fastlane/metadata/"
    puts "   - fastlane/screenshots/"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  desc "ë©”íƒ€ë°ì´í„°ë¥¼ App Store Connectì— ì—…ë¡œë“œ (ë°”ì´ë„ˆë¦¬ ì—†ì´)"
  desc "ì‚¬ìš©ë²•: fastlane upload_metadata"
  lane :upload_metadata do
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¤ ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì‹œì‘"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    upload_to_app_store(
      api_key: API_KEY,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true
    )

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì™„ë£Œ!"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ”¨ ë¹Œë“œë§Œ (ì—…ë¡œë“œ ì—†ì´)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "ë¹Œë“œë§Œ ìˆ˜í–‰ (ì—…ë¡œë“œ ì—†ì´)"
  desc "ì‚¬ìš©ë²•: fastlane build_only"
  lane :build_only do
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    puts "ğŸ”¨ ë¹Œë“œë§Œ ìˆ˜í–‰: #{version} (#{build_number})"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    puts "âœ… ë¹Œë“œ ì™„ë£Œ: ./build/#{SCHEME}.ipa"
  end

  error do |lane, exception|
    puts "âŒ ì—ëŸ¬ ë°œìƒ: #{exception.message}"
  end
end
