# Fastfile Template for iOS App Store Deployment
# ë²„ì „: 2.0.0 - ëŒ€í™”í˜• ë§ˆë²•ì‚¬ ì§€ì›
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ì´ íŒŒì¼ì€ Claude Codeì˜ ëŒ€í™”í˜• ë§ˆë²•ì‚¬ì—ì„œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.
# ìˆ˜ë™ ì„¤ì • ì‹œ ì•„ë˜ ê°€ì´ë“œë¥¼ ì°¸ê³ í•˜ì„¸ìš”.
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# ëª…ë ¹ì–´:
#   fastlane release                    - App Store ë°°í¬
#   fastlane release notes:"ë¦´ë¦¬ì¦ˆë…¸íŠ¸" - App Store ë°°í¬ (ì»¤ìŠ¤í…€ ë…¸íŠ¸)
#   fastlane beta                       - TestFlight ë°°í¬
#   fastlane build_only                 - ë¹Œë“œë§Œ
#   fastlane sync_metadata              - ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ
#   fastlane upload_metadata            - ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ
#
# ì˜µì…˜:
#   skip_commit:true  - ë²„ì „ ë³€ê²½ ì»¤ë°‹ ê±´ë„ˆë›°ê¸° (CI í™˜ê²½ì—ì„œ ìœ ìš©)

default_platform(:ios)

platform :ios do

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ”§ í”„ë¡œì íŠ¸ ì„¤ì • (ìë™ ìƒì„±ë¨)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  PROJECT = "{{PROJECT_NAME}}.xcodeproj"
  SCHEME = "{{SCHEME_NAME}}"
  BUNDLE_ID = "{{BUNDLE_ID}}"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“¦ ë°°í¬ ì„¤ì • (ëŒ€í™”í˜• ë§ˆë²•ì‚¬ì—ì„œ ì„ íƒ)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  # ë²„ì „ ê´€ë¦¬: "chatgpt" | "semver" | "manual"
  VERSION_STYLE = "{{VERSION_STYLE}}"
  MAJOR_VERSION = "{{MAJOR_VERSION}}"

  # ë©”íƒ€ë°ì´í„° ê´€ë¦¬: true = App Store Connectì—ì„œ ê´€ë¦¬, false = Fastlaneì—ì„œ ê´€ë¦¬
  SKIP_METADATA = {{SKIP_METADATA}}
  SKIP_SCREENSHOTS = {{SKIP_SCREENSHOTS}}

  # ì‹¬ì‚¬/ë¦´ë¦¬ì¦ˆ ì˜µì…˜
  SUBMIT_FOR_REVIEW = {{SUBMIT_FOR_REVIEW}}
  AUTOMATIC_RELEASE = {{AUTOMATIC_RELEASE}}

  # ì‹¬ì‚¬ ì •ë³´
  USES_IDFA = {{USES_IDFA}}

  # ê³ ê¸‰ ì˜µì…˜
  AUTO_COMMIT_VERSION = {{AUTO_COMMIT_VERSION}}

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ” App Store Connect API í‚¤ ì„¤ì •
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  GLOBAL_CONFIG_DIR = File.expand_path("~/.appstore_keys")
  GLOBAL_CONFIG_PATH = "#{GLOBAL_CONFIG_DIR}/config.json"

  def load_global_config
    if File.exist?(GLOBAL_CONFIG_PATH)
      require 'json'
      JSON.parse(File.read(GLOBAL_CONFIG_PATH))
    else
      nil
    end
  end

  def find_api_key_path(config)
    local_key = Dir.glob("fastlane/AuthKey_*.p8").first
    return local_key if local_key

    if config && config.dig("default", "key_file")
      global_key = "#{GLOBAL_CONFIG_DIR}/#{config.dig("default", "key_file")}"
      return global_key if File.exist?(global_key)
    end

    nil
  end

  def validate_api_config!
    config = load_global_config
    key_path = find_api_key_path(config)

    if config.nil? || key_path.nil?
      puts ""
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts "âŒ App Store Connect API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts ""
      puts "ğŸ“ ì„¤ì • ë°©ë²•:"
      puts "   mkdir -p ~/.appstore_keys"
      puts "   # API í‚¤ íŒŒì¼(.p8)ì„ ë³µì‚¬í•˜ê³  config.json ìƒì„±"
      puts ""
      puts "ğŸ“Œ ìì„¸í•œ ë‚´ìš©ì€ ios-fastlane-deploy SKILL.md ì°¸ê³ "
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      UI.user_error!("API í‚¤ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.")
    end

    { config: config, key_path: key_path }
  end

  API_CONFIG = validate_api_config!
  GLOBAL_CONFIG = API_CONFIG[:config]

  API_KEY = app_store_connect_api_key(
    key_id: GLOBAL_CONFIG.dig("default", "key_id"),
    issuer_id: GLOBAL_CONFIG.dig("default", "issuer_id"),
    key_filepath: API_CONFIG[:key_path]
  )

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“Œ ë²„ì „ ìë™ ìƒì„±
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  # ChatGPT ìŠ¤íƒ€ì¼: MAJOR.YEAR.MMDDNNN
  desc "ChatGPT ìŠ¤íƒ€ì¼ ë²„ì „ ìƒì„±"
  private_lane :generate_chatgpt_version do
    now = Time.now
    year = now.strftime("%Y")
    mmdd = now.strftime("%m%d")

    current_version = get_version_number(
      xcodeproj: PROJECT,
      target: SCHEME
    )

    today_pattern = "#{MAJOR_VERSION}.#{year}.#{mmdd}"

    if current_version.start_with?(today_pattern)
      last_three = current_version[-3..-1].to_i
      serial = format("%03d", last_three + 1)
    else
      serial = "001"
    end

    new_version = "#{today_pattern}#{serial}"
    new_build = "#{year}#{mmdd}#{serial}"

    { version: new_version, build: new_build }
  end

  # Semantic Versioning: MAJOR.MINOR.PATCH
  desc "SemVer ìŠ¤íƒ€ì¼ ë²„ì „ ìƒì„± (íŒ¨ì¹˜ ìë™ ì¦ê°€)"
  private_lane :generate_semver_version do
    current_version = get_version_number(
      xcodeproj: PROJECT,
      target: SCHEME
    )

    parts = current_version.split(".")
    major = parts[0] || MAJOR_VERSION
    minor = parts[1] || "0"
    patch = (parts[2] || "0").to_i + 1

    new_version = "#{major}.#{minor}.#{patch}"
    new_build = Time.now.strftime("%Y%m%d%H%M")

    { version: new_version, build: new_build }
  end

  desc "ë²„ì „ ìƒì„± (ìŠ¤íƒ€ì¼ì— ë”°ë¼)"
  private_lane :generate_version do
    case VERSION_STYLE
    when "chatgpt"
      generate_chatgpt_version
    when "semver"
      generate_semver_version
    else
      # manual - í˜„ì¬ ë²„ì „ ìœ ì§€, ë¹Œë“œ ë²ˆí˜¸ë§Œ ì¦ê°€
      current_version = get_version_number(xcodeproj: PROJECT, target: SCHEME)
      { version: current_version, build: Time.now.strftime("%Y%m%d%H%M") }
    end
  end

  desc "ë²„ì „ ì—…ë°ì´íŠ¸ ì ìš©"
  private_lane :apply_version do |options|
    version_info = options[:version_info]

    increment_version_number(
      xcodeproj: PROJECT,
      version_number: version_info[:version]
    )

    increment_build_number(
      xcodeproj: PROJECT,
      build_number: version_info[:build]
    )

    puts "ğŸ“Œ ë²„ì „ ì—…ë°ì´íŠ¸: #{version_info[:version]} (#{version_info[:build]})"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“ ë²„ì „ ë³€ê²½ ìë™ ì»¤ë°‹
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "ë²„ì „ ë³€ê²½ ì‚¬í•­ì„ Gitì— ì»¤ë°‹"
  private_lane :commit_version do |options|
    version = options[:version]
    skip_commit = options[:skip_commit] || false

    # ìë™ ì»¤ë°‹ ë¹„í™œì„±í™” ë˜ëŠ” CI í™˜ê²½ì´ë©´ ê±´ë„ˆë›°ê¸°
    if !AUTO_COMMIT_VERSION || skip_commit || ENV['CI'] == 'true'
      puts "â­ï¸  ë²„ì „ ì»¤ë°‹ ê±´ë„ˆëœ€"
      next
    end

    unless File.directory?(".git")
      puts "âš ï¸  Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤. ì»¤ë°‹ ê±´ë„ˆëœ€."
      next
    end

    changed_files = sh("git diff --name-only", log: false).strip
    if changed_files.empty?
      puts "â„¹ï¸  ë³€ê²½ëœ íŒŒì¼ ì—†ìŒ"
      next
    end

    project_file = "#{PROJECT}/project.pbxproj"
    if changed_files.include?("project.pbxproj")
      git_add(path: project_file)
      git_commit(
        path: project_file,
        message: "chore: bump version to #{version}",
        allow_nothing_to_commit: true
      )
      puts "âœ… ë²„ì „ ë³€ê²½ ì»¤ë°‹ ì™„ë£Œ: #{version}"
    end
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“ ë¦´ë¦¬ì¦ˆë…¸íŠ¸ ìƒì„±
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "ë¦´ë¦¬ì¦ˆë…¸íŠ¸ ê°€ì ¸ì˜¤ê¸°"
  private_lane :get_release_notes do |options|
    custom_notes = options[:notes]
    notes_file = "fastlane/release_notes.txt"

    default_notes = {
      "en-US" => "Improved stability and performance.",
      "ko" => "ì•ˆì •ì„±ì„ ê°œì„ í•˜ì˜€ì–´ìš”."
    }

    if custom_notes && !custom_notes.empty?
      puts "ğŸ“ ë¦´ë¦¬ì¦ˆë…¸íŠ¸: ì»¤ìŠ¤í…€ (íŒŒë¼ë¯¸í„°)"
      {
        "default" => custom_notes,
        "en-US" => custom_notes,
        "ko" => custom_notes
      }
    elsif File.exist?(notes_file)
      content = File.read(notes_file).strip
      puts "ğŸ“ ë¦´ë¦¬ì¦ˆë…¸íŠ¸: íŒŒì¼ (#{notes_file})"

      if content.include?("[ko]") || content.include?("[en-US]")
        notes = { "default" => "" }
        current_lang = "default"

        content.each_line do |line|
          line = line.strip
          if line.match(/^\[(.+)\]$/)
            current_lang = $1
            notes[current_lang] ||= ""
          elsif !line.empty?
            notes[current_lang] += (notes[current_lang].empty? ? "" : "\n") + line
          end
        end

        notes["default"] = notes["ko"] || notes["en-US"] || content
        notes
      else
        {
          "default" => content,
          "en-US" => content,
          "ko" => content
        }
      end
    else
      puts "ğŸ“ ë¦´ë¦¬ì¦ˆë…¸íŠ¸: ê¸°ë³¸ê°’"
      {
        "default" => default_notes["ko"],
        "en-US" => default_notes["en-US"],
        "ko" => default_notes["ko"]
      }
    end
  end

  before_all do
    # Git ìƒíƒœ í™•ì¸ (í•„ìš” ì‹œ í™œì„±í™”)
    # ensure_git_status_clean
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸš€ App Store ë°°í¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "App Store ë°°í¬"
  desc "ì‚¬ìš©ë²•: fastlane release [notes:'ë¦´ë¦¬ì¦ˆë…¸íŠ¸'] [skip_commit:true]"
  lane :release do |options|
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    release_notes = get_release_notes(notes: options[:notes])

    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¦ App Store ë°°í¬ ì‹œì‘"
    puts "   ë²„ì „: #{version}"
    puts "   ë¹Œë“œ: #{build_number}"
    puts "   ë©”íƒ€ë°ì´í„°: #{SKIP_METADATA ? 'ê±´ë„ˆëœ€' : 'ì—…ë¡œë“œ'}"
    puts "   ìŠ¤í¬ë¦°ìƒ·: #{SKIP_SCREENSHOTS ? 'ê±´ë„ˆëœ€' : 'ì—…ë¡œë“œ'}"
    puts "   ì‹¬ì‚¬ ì œì¶œ: #{SUBMIT_FOR_REVIEW ? 'ìë™' : 'ìˆ˜ë™'}"
    puts "   ìë™ ë¦´ë¦¬ì¦ˆ: #{AUTOMATIC_RELEASE ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    puts "âœ… ë¹Œë“œ ì™„ë£Œ: ./build/#{SCHEME}.ipa"

    upload_to_app_store(
      api_key: API_KEY,
      skip_metadata: SKIP_METADATA,
      skip_screenshots: SKIP_SCREENSHOTS,
      skip_binary_upload: false,
      force: true,
      submit_for_review: SUBMIT_FOR_REVIEW,
      automatic_release: AUTOMATIC_RELEASE,
      run_precheck_before_submit: false,
      submission_information: {
        add_id_info_uses_idfa: USES_IDFA
      },
      release_notes: release_notes
    )

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… App Store ë°°í¬ ì™„ë£Œ!"
    puts "   ë²„ì „: #{version} (#{build_number})"
    if SUBMIT_FOR_REVIEW
      puts "   ìƒíƒœ: ì‹¬ì‚¬ ëŒ€ê¸° ì¤‘"
    else
      puts "   ìƒíƒœ: App Store Connectì—ì„œ ì‹¬ì‚¬ ì œì¶œ í•„ìš”"
    end
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # ë¦´ë¦¬ì¦ˆë…¸íŠ¸ íŒŒì¼ ì •ë¦¬
    notes_file = "fastlane/release_notes.txt"
    if File.exist?(notes_file)
      File.delete(notes_file)
      puts "ğŸ—‘ï¸  ë¦´ë¦¬ì¦ˆë…¸íŠ¸ íŒŒì¼ ì‚­ì œë¨"
    end

    commit_version(version: version, skip_commit: options[:skip_commit])
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ§ª TestFlight ë² íƒ€ ë°°í¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "TestFlight ë² íƒ€ ë°°í¬"
  desc "ì‚¬ìš©ë²•: fastlane beta [skip_commit:true] [changelog:'ë³€ê²½ì‚¬í•­']"
  lane :beta do |options|
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ§ª TestFlight ë°°í¬ ì‹œì‘"
    puts "   ë²„ì „: #{version}"
    puts "   ë¹Œë“œ: #{build_number}"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    upload_to_testflight(
      api_key: API_KEY,
      skip_waiting_for_build_processing: true,
      changelog: options[:changelog]
    )

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… TestFlight ì—…ë¡œë“œ ì™„ë£Œ!"
    puts "   ë²„ì „: #{version} (#{build_number})"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    commit_version(version: version, skip_commit: options[:skip_commit])
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“¥ ë©”íƒ€ë°ì´í„° ë™ê¸°í™”
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "App Store Connectì—ì„œ ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ"
  lane :sync_metadata do
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¥ ë©”íƒ€ë°ì´í„° ë™ê¸°í™” ì‹œì‘"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    global_api_key_json = "#{GLOBAL_CONFIG_DIR}/api_key.json"

    puts "\nğŸ“ ë©”íƒ€ë°ì´í„° & ìŠ¤í¬ë¦°ìƒ· ë‹¤ìš´ë¡œë“œ ì¤‘..."
    sh("fastlane deliver init --app_identifier '#{BUNDLE_ID}' --api_key_path '#{global_api_key_json}' --use_live_version true")

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… ë©”íƒ€ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ!"
    puts "   - fastlane/metadata/"
    puts "   - fastlane/screenshots/"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  desc "ë©”íƒ€ë°ì´í„°ë¥¼ App Store Connectì— ì—…ë¡œë“œ"
  lane :upload_metadata do
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¤ ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì‹œì‘"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    upload_to_app_store(
      api_key: API_KEY,
      skip_binary_upload: true,
      skip_screenshots: SKIP_SCREENSHOTS,
      skip_metadata: false,
      force: true
    )

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì™„ë£Œ!"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ”¨ ë¹Œë“œë§Œ (ì—…ë¡œë“œ ì—†ì´)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "ë¹Œë“œë§Œ ìˆ˜í–‰"
  lane :build_only do
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    puts "ğŸ”¨ ë¹Œë“œë§Œ ìˆ˜í–‰: #{version} (#{build_number})"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    puts "âœ… ë¹Œë“œ ì™„ë£Œ: ./build/#{SCHEME}.ipa"
  end

  error do |lane, exception|
    puts "âŒ ì—ëŸ¬ ë°œìƒ: #{exception.message}"
  end
end
