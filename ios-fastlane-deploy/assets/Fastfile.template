# Fastfile Template for iOS App Store Deployment
# ë²„ì „: 2.1.0 - .env ì§€ì› ë° ë²„ì „ ì»¤ë°‹ ê°œì„ 
#
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ì´ íŒŒì¼ì€ Claude Codeì˜ ëŒ€í™”í˜• ë§ˆë²•ì‚¬ì—ì„œ ìë™ ìƒì„±ë©ë‹ˆë‹¤.
# ìˆ˜ë™ ì„¤ì • ì‹œ ì•„ë˜ ê°€ì´ë“œë¥¼ ì°¸ê³ í•˜ì„¸ìš”.
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#
# ëª…ë ¹ì–´:
#   fastlane release                    - App Store ë°°í¬
#   fastlane release notes:"ë¦´ë¦¬ì¦ˆë…¸íŠ¸" - App Store ë°°í¬ (ì»¤ìŠ¤í…€ ë…¸íŠ¸)
#   fastlane beta                       - TestFlight ë°°í¬
#   fastlane build_only                 - ë¹Œë“œë§Œ
#   fastlane sync_metadata              - ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ
#   fastlane upload_metadata            - ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ
#
# ì˜µì…˜:
#   skip_commit:true  - ë²„ì „ ë³€ê²½ ì»¤ë°‹ ê±´ë„ˆë›°ê¸° (CI í™˜ê²½ì—ì„œ ìœ ìš©)

# .env íŒŒì¼ ë¡œë“œ (ìˆìœ¼ë©´)
begin
  require 'dotenv'
  Dotenv.load
rescue LoadError
  # dotenv gemì´ ì—†ìœ¼ë©´ ë¬´ì‹œ
end

default_platform(:ios)

platform :ios do

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ”§ í”„ë¡œì íŠ¸ ì„¤ì • (ìë™ ìƒì„±ë¨)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  PROJECT = "{{PROJECT_NAME}}.xcodeproj"
  SCHEME = "{{SCHEME_NAME}}"
  BUNDLE_ID = "{{BUNDLE_ID}}"

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“¦ ë°°í¬ ì„¤ì • (ëŒ€í™”í˜• ë§ˆë²•ì‚¬ì—ì„œ ì„ íƒ)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  # ë²„ì „ ê´€ë¦¬: "chatgpt" | "semver" | "manual"
  VERSION_STYLE = "{{VERSION_STYLE}}"
  MAJOR_VERSION = "{{MAJOR_VERSION}}"

  # ë©”íƒ€ë°ì´í„° ê´€ë¦¬: true = App Store Connectì—ì„œ ê´€ë¦¬, false = Fastlaneì—ì„œ ê´€ë¦¬
  SKIP_METADATA = {{SKIP_METADATA}}
  SKIP_SCREENSHOTS = {{SKIP_SCREENSHOTS}}

  # ì‹¬ì‚¬/ë¦´ë¦¬ì¦ˆ ì˜µì…˜
  SUBMIT_FOR_REVIEW = {{SUBMIT_FOR_REVIEW}}
  AUTOMATIC_RELEASE = {{AUTOMATIC_RELEASE}}

  # ì‹¬ì‚¬ ì •ë³´
  USES_IDFA = {{USES_IDFA}}

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ” App Store Connect API í‚¤ ì„¤ì •
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # API í‚¤ ê´€ë¦¬ ë°©ì‹: "global" | "env"
  API_KEY_MODE = "{{API_KEY_MODE}}"

  GLOBAL_CONFIG_DIR = File.expand_path("~/.appstore_keys")
  GLOBAL_CONFIG_PATH = "#{GLOBAL_CONFIG_DIR}/config.json"

  # ì „ì—­ config.json ë¡œë“œ
  def load_global_config
    if File.exist?(GLOBAL_CONFIG_PATH)
      require 'json'
      JSON.parse(File.read(GLOBAL_CONFIG_PATH))
    else
      nil
    end
  end

  # .envì—ì„œ API í‚¤ ì •ë³´ ë¡œë“œ
  def load_env_config
    key_id = ENV['APP_STORE_KEY_ID']
    issuer_id = ENV['APP_STORE_ISSUER_ID']
    key_file = ENV['APP_STORE_KEY_FILE']

    if key_id && issuer_id && key_file
      {
        "key_id" => key_id,
        "issuer_id" => issuer_id,
        "key_file" => key_file
      }
    else
      nil
    end
  end

  # API í‚¤ íŒŒì¼ ê²½ë¡œ ì°¾ê¸°
  def find_api_key_path(config, mode)
    # 1. ë¡œì»¬ fastlane ë””ë ‰í† ë¦¬ í™•ì¸
    local_key = Dir.glob("fastlane/AuthKey_*.p8").first
    return local_key if local_key

    # 2. .env ëª¨ë“œ: í™˜ê²½ë³€ìˆ˜ì—ì„œ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
    if mode == "env" && config && config["key_file"]
      env_key = File.expand_path(config["key_file"])
      return env_key if File.exist?(env_key)
    end

    # 3. ì „ì—­ í´ë” ëª¨ë“œ: ~/.appstore_keys/ì—ì„œ ì°¾ê¸°
    if mode == "global" && config && config.dig("default", "key_file")
      global_key = "#{GLOBAL_CONFIG_DIR}/#{config.dig("default", "key_file")}"
      return global_key if File.exist?(global_key)
    end

    nil
  end

  # API ì„¤ì • ê²€ì¦
  def validate_api_config!
    env_config = load_env_config
    global_config = load_global_config

    # .env ìš°ì„ , ì—†ìœ¼ë©´ ì „ì—­ ì„¤ì • ì‚¬ìš©
    if env_config
      config = env_config
      mode = "env"
    elsif global_config
      config = global_config
      mode = "global"
    else
      config = nil
      mode = nil
    end

    key_path = find_api_key_path(config, mode)

    if config.nil? || key_path.nil?
      puts ""
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts "âŒ App Store Connect API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!"
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      puts ""
      puts "ğŸ“ ë°©ë²• 1: ì „ì—­ í´ë” (~/.appstore_keys/)"
      puts "   mkdir -p ~/.appstore_keys"
      puts "   # AuthKey_XXXXXX.p8 ë³µì‚¬ í›„ config.json ìƒì„±"
      puts ""
      puts "ğŸ“ ë°©ë²• 2: í”„ë¡œì íŠ¸ .env íŒŒì¼"
      puts "   cp .env.template .env"
      puts "   # .env íŒŒì¼ì— API í‚¤ ì •ë³´ ì…ë ¥"
      puts ""
      puts "ğŸ“Œ ìì„¸í•œ ë‚´ìš©ì€ ios-fastlane-deploy SKILL.md ì°¸ê³ "
      puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      UI.user_error!("API í‚¤ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.")
    end

    puts "ğŸ”‘ API í‚¤ ëª¨ë“œ: #{mode == 'env' ? '.env íŒŒì¼' : 'ì „ì—­ í´ë”'}"
    { config: config, key_path: key_path, mode: mode }
  end

  API_CONFIG = validate_api_config!
  LOADED_CONFIG = API_CONFIG[:config]
  API_KEY_PATH = API_CONFIG[:key_path]
  DETECTED_MODE = API_CONFIG[:mode]

  # API í‚¤ ìƒì„± (ëª¨ë“œì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì²˜ë¦¬)
  API_KEY = app_store_connect_api_key(
    key_id: DETECTED_MODE == "env" ? LOADED_CONFIG["key_id"] : LOADED_CONFIG.dig("default", "key_id"),
    issuer_id: DETECTED_MODE == "env" ? LOADED_CONFIG["issuer_id"] : LOADED_CONFIG.dig("default", "issuer_id"),
    key_filepath: API_KEY_PATH
  )

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“Œ ë²„ì „ ìë™ ìƒì„±
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  # ChatGPT ìŠ¤íƒ€ì¼: MAJOR.YEAR.MMDDNNN
  desc "ChatGPT ìŠ¤íƒ€ì¼ ë²„ì „ ìƒì„±"
  private_lane :generate_chatgpt_version do
    now = Time.now
    year = now.strftime("%Y")
    mmdd = now.strftime("%m%d")

    current_version = get_version_number(
      xcodeproj: PROJECT,
      target: SCHEME
    )

    today_pattern = "#{MAJOR_VERSION}.#{year}.#{mmdd}"

    if current_version.start_with?(today_pattern)
      last_three = current_version[-3..-1].to_i
      serial = format("%03d", last_three + 1)
    else
      serial = "001"
    end

    new_version = "#{today_pattern}#{serial}"
    new_build = "#{year}#{mmdd}#{serial}"

    { version: new_version, build: new_build }
  end

  # Semantic Versioning: MAJOR.MINOR.PATCH
  desc "SemVer ìŠ¤íƒ€ì¼ ë²„ì „ ìƒì„± (íŒ¨ì¹˜ ìë™ ì¦ê°€)"
  private_lane :generate_semver_version do
    current_version = get_version_number(
      xcodeproj: PROJECT,
      target: SCHEME
    )

    parts = current_version.split(".")
    major = parts[0] || MAJOR_VERSION
    minor = parts[1] || "0"
    patch = (parts[2] || "0").to_i + 1

    new_version = "#{major}.#{minor}.#{patch}"
    new_build = Time.now.strftime("%Y%m%d%H%M")

    { version: new_version, build: new_build }
  end

  desc "ë²„ì „ ìƒì„± (ìŠ¤íƒ€ì¼ì— ë”°ë¼)"
  private_lane :generate_version do
    case VERSION_STYLE
    when "chatgpt"
      generate_chatgpt_version
    when "semver"
      generate_semver_version
    else
      # manual - í˜„ì¬ ë²„ì „ ìœ ì§€, ë¹Œë“œ ë²ˆí˜¸ë§Œ ì¦ê°€
      current_version = get_version_number(xcodeproj: PROJECT, target: SCHEME)
      { version: current_version, build: Time.now.strftime("%Y%m%d%H%M") }
    end
  end

  desc "ë²„ì „ ì—…ë°ì´íŠ¸ ì ìš©"
  private_lane :apply_version do |options|
    version_info = options[:version_info]

    increment_version_number(
      xcodeproj: PROJECT,
      version_number: version_info[:version]
    )

    increment_build_number(
      xcodeproj: PROJECT,
      build_number: version_info[:build]
    )

    puts "ğŸ“Œ ë²„ì „ ì—…ë°ì´íŠ¸: #{version_info[:version]} (#{version_info[:build]})"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“ ë²„ì „ ë³€ê²½ ìë™ ì»¤ë°‹ (ë°°í¬ ì„±ê³µ í›„)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ë²„ì „ ì»¤ë°‹ ëª¨ë“œ: "always" | "local_only" | "never"
  VERSION_COMMIT_MODE = "{{VERSION_COMMIT_MODE}}"

  desc "ë²„ì „ ë³€ê²½ ì‚¬í•­ì„ Gitì— ì»¤ë°‹ ë° í‘¸ì‹œ"
  private_lane :commit_version_after_deploy do |options|
    version = options[:version]
    build_number = options[:build_number]
    deploy_type = options[:deploy_type] || "release"
    skip_commit = options[:skip_commit] || false

    puts ""
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“ ë²„ì „ ì»¤ë°‹ ì²˜ë¦¬ ì¤‘..."
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # ì»¤ë°‹ ìŠ¤í‚µ ì¡°ê±´ í™•ì¸
    if skip_commit
      puts "â­ï¸  skip_commit ì˜µì…˜ìœ¼ë¡œ ê±´ë„ˆëœ€"
      next
    end

    if VERSION_COMMIT_MODE == "never"
      puts "â­ï¸  VERSION_COMMIT_MODE=neverë¡œ ê±´ë„ˆëœ€"
      next
    end

    if VERSION_COMMIT_MODE == "local_only" && ENV['CI'] == 'true'
      puts "â­ï¸  CI í™˜ê²½ì—ì„œëŠ” ê±´ë„ˆëœ€ (local_only ëª¨ë“œ)"
      next
    end

    unless File.directory?(".git")
      puts "âš ï¸  Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤. ì»¤ë°‹ ê±´ë„ˆëœ€."
      next
    end

    # ë³€ê²½ëœ íŒŒì¼ í™•ì¸
    changed_files = sh("git diff --name-only", log: false).strip
    staged_files = sh("git diff --cached --name-only", log: false).strip
    all_changes = "#{changed_files}\n#{staged_files}".strip

    if all_changes.empty?
      puts "â„¹ï¸  ë³€ê²½ëœ íŒŒì¼ ì—†ìŒ"
      next
    end

    # í”„ë¡œì íŠ¸ íŒŒì¼ ì»¤ë°‹
    project_file = "#{PROJECT}/project.pbxproj"

    if all_changes.include?("project.pbxproj")
      # ìŠ¤í…Œì´ì§•
      git_add(path: project_file)

      # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
      commit_message = "chore(release): bump version to #{version} (#{build_number})\n\n- Deploy type: #{deploy_type}\n- Build: #{build_number}"

      git_commit(
        path: project_file,
        message: commit_message,
        allow_nothing_to_commit: true
      )

      puts "âœ… ë²„ì „ ë³€ê²½ ì»¤ë°‹ ì™„ë£Œ"
      puts "   ë²„ì „: #{version}"
      puts "   ë¹Œë“œ: #{build_number}"

      # íƒœê·¸ ìƒì„± (App Store ë°°í¬ ì‹œ)
      if deploy_type == "release"
        tag_name = "v#{version}"
        begin
          add_git_tag(tag: tag_name)
          puts "ğŸ·ï¸  íƒœê·¸ ìƒì„±: #{tag_name}"
        rescue => e
          puts "âš ï¸  íƒœê·¸ ìƒì„± ì‹¤íŒ¨ (ì´ë¯¸ ì¡´ì¬í•  ìˆ˜ ìˆìŒ): #{e.message}"
        end
      end

      # ì›ê²© ì €ì¥ì†Œë¡œ í‘¸ì‹œ (CIê°€ ì•„ë‹Œ ê²½ìš°)
      if ENV['CI'] != 'true' && VERSION_COMMIT_MODE == "always"
        begin
          push_to_git_remote(
            remote: "origin",
            tags: deploy_type == "release"
          )
          puts "ğŸš€ ì›ê²© ì €ì¥ì†Œì— í‘¸ì‹œ ì™„ë£Œ"
        rescue => e
          puts "âš ï¸  í‘¸ì‹œ ì‹¤íŒ¨: #{e.message}"
          puts "   ìˆ˜ë™ìœ¼ë¡œ í‘¸ì‹œí•´ì£¼ì„¸ìš”: git push && git push --tags"
        end
      end
    else
      puts "â„¹ï¸  project.pbxproj ë³€ê²½ ì—†ìŒ"
    end

    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“ ë¦´ë¦¬ì¦ˆë…¸íŠ¸ ìƒì„±
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "ë¦´ë¦¬ì¦ˆë…¸íŠ¸ ê°€ì ¸ì˜¤ê¸°"
  private_lane :get_release_notes do |options|
    custom_notes = options[:notes]
    notes_file = "fastlane/release_notes.txt"

    default_notes = {
      "en-US" => "Improved stability and performance.",
      "ko" => "ì•ˆì •ì„±ì„ ê°œì„ í•˜ì˜€ì–´ìš”."
    }

    if custom_notes && !custom_notes.empty?
      puts "ğŸ“ ë¦´ë¦¬ì¦ˆë…¸íŠ¸: ì»¤ìŠ¤í…€ (íŒŒë¼ë¯¸í„°)"
      {
        "default" => custom_notes,
        "en-US" => custom_notes,
        "ko" => custom_notes
      }
    elsif File.exist?(notes_file)
      content = File.read(notes_file).strip
      puts "ğŸ“ ë¦´ë¦¬ì¦ˆë…¸íŠ¸: íŒŒì¼ (#{notes_file})"

      if content.include?("[ko]") || content.include?("[en-US]")
        notes = { "default" => "" }
        current_lang = "default"

        content.each_line do |line|
          line = line.strip
          if line.match(/^\[(.+)\]$/)
            current_lang = $1
            notes[current_lang] ||= ""
          elsif !line.empty?
            notes[current_lang] += (notes[current_lang].empty? ? "" : "\n") + line
          end
        end

        notes["default"] = notes["ko"] || notes["en-US"] || content
        notes
      else
        {
          "default" => content,
          "en-US" => content,
          "ko" => content
        }
      end
    else
      puts "ğŸ“ ë¦´ë¦¬ì¦ˆë…¸íŠ¸: ê¸°ë³¸ê°’"
      {
        "default" => default_notes["ko"],
        "en-US" => default_notes["en-US"],
        "ko" => default_notes["ko"]
      }
    end
  end

  before_all do
    # Git ìƒíƒœ í™•ì¸ (í•„ìš” ì‹œ í™œì„±í™”)
    # ensure_git_status_clean
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸš€ App Store ë°°í¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "App Store ë°°í¬"
  desc "ì‚¬ìš©ë²•: fastlane release [notes:'ë¦´ë¦¬ì¦ˆë…¸íŠ¸'] [skip_commit:true]"
  lane :release do |options|
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    release_notes = get_release_notes(notes: options[:notes])

    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¦ App Store ë°°í¬ ì‹œì‘"
    puts "   ë²„ì „: #{version}"
    puts "   ë¹Œë“œ: #{build_number}"
    puts "   ë©”íƒ€ë°ì´í„°: #{SKIP_METADATA ? 'ê±´ë„ˆëœ€' : 'ì—…ë¡œë“œ'}"
    puts "   ìŠ¤í¬ë¦°ìƒ·: #{SKIP_SCREENSHOTS ? 'ê±´ë„ˆëœ€' : 'ì—…ë¡œë“œ'}"
    puts "   ì‹¬ì‚¬ ì œì¶œ: #{SUBMIT_FOR_REVIEW ? 'ìë™' : 'ìˆ˜ë™'}"
    puts "   ìë™ ë¦´ë¦¬ì¦ˆ: #{AUTOMATIC_RELEASE ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'}"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    puts "âœ… ë¹Œë“œ ì™„ë£Œ: ./build/#{SCHEME}.ipa"

    upload_to_app_store(
      api_key: API_KEY,
      skip_metadata: SKIP_METADATA,
      skip_screenshots: SKIP_SCREENSHOTS,
      skip_binary_upload: false,
      force: true,
      submit_for_review: SUBMIT_FOR_REVIEW,
      automatic_release: AUTOMATIC_RELEASE,
      run_precheck_before_submit: false,
      submission_information: {
        add_id_info_uses_idfa: USES_IDFA
      },
      release_notes: release_notes
    )

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… App Store ë°°í¬ ì™„ë£Œ!"
    puts "   ë²„ì „: #{version} (#{build_number})"
    if SUBMIT_FOR_REVIEW
      puts "   ìƒíƒœ: ì‹¬ì‚¬ ëŒ€ê¸° ì¤‘"
    else
      puts "   ìƒíƒœ: App Store Connectì—ì„œ ì‹¬ì‚¬ ì œì¶œ í•„ìš”"
    end
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # ë¦´ë¦¬ì¦ˆë…¸íŠ¸ íŒŒì¼ ì •ë¦¬
    notes_file = "fastlane/release_notes.txt"
    if File.exist?(notes_file)
      File.delete(notes_file)
      puts "ğŸ—‘ï¸  ë¦´ë¦¬ì¦ˆë…¸íŠ¸ íŒŒì¼ ì‚­ì œë¨"
    end

    # ë°°í¬ ì„±ê³µ í›„ ë²„ì „ ì»¤ë°‹ & í‘¸ì‹œ
    commit_version_after_deploy(
      version: version,
      build_number: build_number,
      deploy_type: "release",
      skip_commit: options[:skip_commit]
    )
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ§ª TestFlight ë² íƒ€ ë°°í¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "TestFlight ë² íƒ€ ë°°í¬"
  desc "ì‚¬ìš©ë²•: fastlane beta [skip_commit:true] [changelog:'ë³€ê²½ì‚¬í•­']"
  lane :beta do |options|
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ§ª TestFlight ë°°í¬ ì‹œì‘"
    puts "   ë²„ì „: #{version}"
    puts "   ë¹Œë“œ: #{build_number}"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    upload_to_testflight(
      api_key: API_KEY,
      skip_waiting_for_build_processing: true,
      changelog: options[:changelog]
    )

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… TestFlight ì—…ë¡œë“œ ì™„ë£Œ!"
    puts "   ë²„ì „: #{version} (#{build_number})"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # ë°°í¬ ì„±ê³µ í›„ ë²„ì „ ì»¤ë°‹ (íƒœê·¸ ì—†ì´)
    commit_version_after_deploy(
      version: version,
      build_number: build_number,
      deploy_type: "beta",
      skip_commit: options[:skip_commit]
    )
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“¥ ë©”íƒ€ë°ì´í„° ë™ê¸°í™”
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "App Store Connectì—ì„œ ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ"
  lane :sync_metadata do
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¥ ë©”íƒ€ë°ì´í„° ë™ê¸°í™” ì‹œì‘"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    global_api_key_json = "#{GLOBAL_CONFIG_DIR}/api_key.json"

    puts "\nğŸ“ ë©”íƒ€ë°ì´í„° & ìŠ¤í¬ë¦°ìƒ· ë‹¤ìš´ë¡œë“œ ì¤‘..."
    sh("fastlane deliver init --app_identifier '#{BUNDLE_ID}' --api_key_path '#{global_api_key_json}' --use_live_version true")

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… ë©”íƒ€ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ!"
    puts "   - fastlane/metadata/"
    puts "   - fastlane/screenshots/"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  desc "ë©”íƒ€ë°ì´í„°ë¥¼ App Store Connectì— ì—…ë¡œë“œ"
  lane :upload_metadata do
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¤ ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì‹œì‘"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    upload_to_app_store(
      api_key: API_KEY,
      skip_binary_upload: true,
      skip_screenshots: SKIP_SCREENSHOTS,
      skip_metadata: false,
      force: true
    )

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì™„ë£Œ!"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ”¨ ë¹Œë“œë§Œ (ì—…ë¡œë“œ ì—†ì´)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "ë¹Œë“œë§Œ ìˆ˜í–‰"
  lane :build_only do
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    puts "ğŸ”¨ ë¹Œë“œë§Œ ìˆ˜í–‰: #{version} (#{build_number})"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    puts "âœ… ë¹Œë“œ ì™„ë£Œ: ./build/#{SCHEME}.ipa"
  end

  error do |lane, exception|
    puts "âŒ ì—ëŸ¬ ë°œìƒ: #{exception.message}"
  end
end
