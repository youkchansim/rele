# Fastfile for Android
# Generated by android-fastlane-deploy
# Version format: MAJOR.YEAR.MMDDNNN (ChatGPT style)
#
# Available lanes:
#   fastlane screenshots        - Capture screenshots for all locales
#   fastlane screenshots_ko     - Capture Korean screenshots only
#   fastlane screenshots_en     - Capture English screenshots only
#   fastlane add_titles         - Apply iOS-style frames to screenshots
#   fastlane internal           - Deploy to internal testing
#   fastlane beta               - Deploy to closed testing (beta)
#   fastlane release            - Deploy to production
#   fastlane build_only         - Build release AAB without uploading
#   fastlane sync_metadata      - Download metadata from Google Play
#   fastlane upload_metadata    - Upload metadata to Google Play
#
# Release notes options:
#   1. No parameter: use default ("Improved stability and performance.")
#   2. notes:"text": specify directly
#   3. If fastlane/release_notes.txt exists, use its content

default_platform(:android)

platform :android do

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Configuration
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  PACKAGE_NAME = "{{PACKAGE_NAME}}"
  MAJOR_VERSION = "1"  # Increment manually for breaking changes
  EMULATOR_KO = "Screenshot_KO"
  EMULATOR_EN = "Screenshot_EN"
  ADB = "#{ENV['HOME']}/Library/Android/sdk/platform-tools/adb"
  EMULATOR_CMD = "#{ENV['HOME']}/Library/Android/sdk/emulator/emulator"

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Google Play Console API Key Setup
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  GLOBAL_CONFIG_DIR = File.expand_path("~/.playstore_keys")
  GLOBAL_CONFIG_PATH = "#{GLOBAL_CONFIG_DIR}/config.json"

  # Load global config
  def load_global_config
    if File.exist?(GLOBAL_CONFIG_PATH)
      require 'json'
      JSON.parse(File.read(GLOBAL_CONFIG_PATH))
    else
      nil
    end
  end

  # Find Service Account JSON key path (project local -> global)
  def find_json_key_path(config)
    # 1. Project local (e.g., fastlane/play-store-credentials.json for CI/CD)
    local_key = Dir.glob("fastlane/*.json").first
    return local_key if local_key

    # 2. Global shared location
    if config && config["json_key_file"]
      global_key = "#{GLOBAL_CONFIG_DIR}/#{config["json_key_file"]}"
      return global_key if File.exist?(global_key)
    end

    nil
  end

  # Validate API config and show setup guide on failure
  def validate_api_config!
    config = load_global_config
    key_path = find_json_key_path(config)

    if config.nil? || key_path.nil?
      puts ""
      puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      puts "Google Play Console API key is not configured!"
      puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      puts ""
      puts "Setup steps:"
      puts ""
      puts "1. Create directory:"
      puts "   mkdir -p ~/.playstore_keys"
      puts ""
      puts "2. Copy Service Account JSON key file:"
      puts "   cp /path/to/service-account.json ~/.playstore_keys/"
      puts ""
      puts "3. Create config.json:"
      puts "   cat > ~/.playstore_keys/config.json << 'EOF'"
      puts '   {'
      puts '     "json_key_file": "service-account.json"'
      puts '   }'
      puts "   EOF"
      puts ""
      puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
      UI.user_error!("API key setup required. See the guide above.")
    end

    { config: config, key_path: key_path }
  end

  # Validate on load
  API_CONFIG = validate_api_config!
  JSON_KEY_PATH = API_CONFIG[:key_path]

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Version Management (ChatGPT style: MAJOR.YEAR.MMDDNNN)
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  private_lane :generate_version do
    now = Time.now
    year = now.strftime("%Y")
    mmdd = now.strftime("%m%d")

    gradle_file = "../app/build.gradle"
    current_version = ""
    current_version_code = 0

    File.readlines(gradle_file).each do |line|
      if line.include?("versionName")
        current_version = line.match(/versionName\s+"(.+)"/)[1] rescue ""
      end
      if line.include?("versionCode")
        current_version_code = line.match(/versionCode\s+(\d+)/)[1].to_i rescue 0
      end
    end

    today_pattern = "#{MAJOR_VERSION}.#{year}.#{mmdd}"

    if current_version.start_with?(today_pattern)
      last_three = current_version[-3..-1].to_i
      serial = format("%03d", last_three + 1)
    else
      serial = "001"
    end

    new_version = "#{today_pattern}#{serial}"
    new_version_code = current_version_code + 1

    { version: new_version, version_code: new_version_code }
  end

  private_lane :apply_version do |options|
    version_info = options[:version_info]
    gradle_file = "../app/build.gradle"

    content = File.read(gradle_file)
    content = content.gsub(/versionName\s+"[^"]+"/, "versionName \"#{version_info[:version]}\"")
    content = content.gsub(/versionCode\s+\d+/, "versionCode #{version_info[:version_code]}")
    File.write(gradle_file, content)

    puts "Version updated: #{version_info[:version]} (#{version_info[:version_code]})"
  end

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Release Notes
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Priority:
  #   1. notes parameter
  #   2. fastlane/release_notes.txt file
  #   3. Default

  private_lane :get_release_notes do |options|
    custom_notes = options[:notes]
    notes_file = "fastlane/release_notes.txt"

    default_notes = {
      "en-US" => "Improved stability and performance.",
      "ko-KR" => "Bug fixes and performance improvements."
    }

    if custom_notes && !custom_notes.empty?
      puts "Release notes: custom (parameter)"
      {
        "default" => custom_notes,
        "en-US" => custom_notes,
        "ko-KR" => custom_notes
      }
    elsif File.exist?(notes_file)
      content = File.read(notes_file).strip
      puts "Release notes: file (#{notes_file})"

      if content.include?("[ko-KR]") || content.include?("[en-US]")
        notes = { "default" => "" }
        current_lang = "default"

        content.each_line do |line|
          line = line.strip
          if line.match(/^\[(.+)\]$/)
            current_lang = $1
            notes[current_lang] ||= ""
          elsif !line.empty?
            notes[current_lang] += (notes[current_lang].empty? ? "" : "\n") + line
          end
        end

        notes["default"] = notes["ko-KR"] || notes["en-US"] || content
        notes
      else
        {
          "default" => content,
          "en-US" => content,
          "ko-KR" => content
        }
      end
    else
      puts "Release notes: default"
      {
        "default" => default_notes["en-US"],
        "en-US" => default_notes["en-US"],
        "ko-KR" => default_notes["ko-KR"]
      }
    end
  end

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Screenshot Lanes
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  desc "Capture screenshots for all locales (Korean + English)"
  lane :screenshots do
    screenshots_ko
    screenshots_en
    add_titles
  end

  desc "Capture Korean screenshots"
  lane :screenshots_ko do
    capture_screenshots_for_locale(
      locale: "ko-KR",
      emulator: EMULATOR_KO
    )
  end

  desc "Capture English screenshots"
  lane :screenshots_en do
    capture_screenshots_for_locale(
      locale: "en-US",
      emulator: EMULATOR_EN
    )
  end

  desc "Apply iOS-style frames to screenshots"
  lane :add_titles do
    puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    puts "Applying frames to screenshots"
    puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    unless system("which magick > /dev/null 2>&1")
      UI.user_error!("ImageMagick required. Install with: brew install imagemagick")
    end

    sh("bash ../fastlane/screenshots/add_titles.sh")

    puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    puts "Frames applied!"
    puts "   Results: fastlane/screenshots/*/images/framed/"
    puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  end

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Deployment Lanes
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  desc "Deploy to internal testing track"
  lane :internal do |options|
    build_and_upload(
      track: "internal",
      notes: options[:notes]
    )
  end

  desc "Deploy to beta (closed testing) track"
  lane :beta do |options|
    build_and_upload(
      track: "internal",
      notes: options[:notes]
    )
  end

  desc "Deploy to production"
  lane :release do |options|
    build_and_upload(
      track: "production",
      notes: options[:notes]
    )
  end

  desc "Build release AAB without uploading"
  lane :build_only do
    version_info = generate_version
    apply_version(version_info: version_info)

    gradle(
      task: "bundle",
      build_type: "Release",
      properties: {
        "android.injected.signing.store.file" => ENV["KEYSTORE_PATH"] || "#{Dir.home}/.android/upload-key.keystore",
        "android.injected.signing.store.password" => ENV["KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["KEY_ALIAS"],
        "android.injected.signing.key.password" => ENV["KEY_PASSWORD"]
      }
    )
    puts "AAB built: app/build/outputs/bundle/release/"
  end

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Metadata Lanes
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  desc "Download metadata from Google Play"
  lane :sync_metadata do
    sh("fastlane supply init --json_key '#{JSON_KEY_PATH}' --package_name '#{PACKAGE_NAME}'")
  end

  desc "Upload metadata to Google Play"
  lane :upload_metadata do
    upload_to_play_store(
      json_key: JSON_KEY_PATH,
      package_name: PACKAGE_NAME,
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false
    )
  end

  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  # Helper Methods
  # ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  private_lane :capture_screenshots_for_locale do |options|
    locale = options[:locale]
    emulator = options[:emulator]

    puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    puts "Capturing #{locale} screenshots"
    puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    # Build screenshot APKs
    puts "\nBuilding screenshot flavor APKs..."
    gradle(task: "assemble", flavor: "screenshot", build_type: "Debug")
    gradle(task: "assemble", flavor: "screenshot", build_type: "DebugAndroidTest")

    # Start emulator
    puts "\nStarting emulator: #{emulator}..."
    start_emulator(emulator: emulator)

    # Wait for emulator to be ready
    puts "Waiting for emulator to boot..."
    sh("#{ADB} wait-for-device")
    sleep(10)

    # Install APKs
    puts "\nInstalling APKs..."
    sh("#{ADB} install -r app/build/outputs/apk/screenshot/debug/app-screenshot-debug.apk")
    sh("#{ADB} install -r app/build/outputs/apk/androidTest/screenshot/debug/app-screenshot-debug-androidTest.apk")

    # Create output directory
    output_dir = "fastlane/screenshots/#{locale}/images/phoneScreenshots"
    sh("mkdir -p ../#{output_dir}")

    # Run screenshot tests
    puts "\nRunning screenshot tests..."
    sh("#{ADB} shell am instrument -w -e class #{PACKAGE_NAME}.screenshot.ScreenshotTest #{PACKAGE_NAME}.test/androidx.test.runner.AndroidJUnitRunner")

    # Pull screenshots from device
    puts "\nPulling screenshots from device..."
    pull_screenshots(locale: locale, output_dir: output_dir)

    # Stop emulator
    puts "\nStopping emulator..."
    stop_emulator

    puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    puts "#{locale} screenshots captured!"
    puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
  end

  private_lane :start_emulator do |options|
    emulator = options[:emulator]

    # Kill any existing emulators
    sh("#{ADB} emu kill") rescue nil
    sleep(2)

    # Start emulator in background
    spawn("#{EMULATOR_CMD} -avd #{emulator} -no-snapshot-load -no-audio -no-boot-anim &")
  end

  private_lane :stop_emulator do
    sh("#{ADB} emu kill") rescue nil
    sleep(2)
  end

  private_lane :pull_screenshots do |options|
    locale = options[:locale]
    output_dir = options[:output_dir]

    # Pull using run-as for permission
    screenshots = %w[01_home 02_timetable 03_profile]

    screenshots.each do |name|
      sh("#{ADB} shell \"run-as #{PACKAGE_NAME} cat /data/data/#{PACKAGE_NAME}/app_screengrab/#{locale}/images/screenshots/#{name}.png\" > ../#{output_dir}/#{name}.png") rescue nil
    end
  end

  private_lane :build_and_upload do |options|
    track = options[:track]

    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    version_code = version_info[:version_code]

    # Get release notes
    release_notes = get_release_notes(notes: options[:notes])

    puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    puts "Deploying to #{track}"
    puts "   Version: #{version} (#{version_code})"
    puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    # Build release AAB
    gradle(
      task: "bundle",
      build_type: "Release",
      properties: {
        "android.injected.signing.store.file" => ENV["KEYSTORE_PATH"] || "#{Dir.home}/.android/upload-key.keystore",
        "android.injected.signing.store.password" => ENV["KEYSTORE_PASSWORD"],
        "android.injected.signing.key.alias" => ENV["KEY_ALIAS"],
        "android.injected.signing.key.password" => ENV["KEY_PASSWORD"]
      }
    )

    # Create changelog files
    version_code_str = version_code.to_s
    ["ko-KR", "en-US"].each do |locale|
      changelog_dir = "fastlane/metadata/android/#{locale}/changelogs"
      FileUtils.mkdir_p(changelog_dir)
      File.write("#{changelog_dir}/#{version_code_str}.txt", release_notes[locale])
    end

    # Upload to Play Store
    upload_to_play_store(
      json_key: JSON_KEY_PATH,
      package_name: PACKAGE_NAME,
      track: track,
      aab: "app/build/outputs/bundle/release/app-release.aab",
      release_status: "completed",
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_changelogs: false,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    puts "Successfully deployed to #{track}!"
    puts "   Version: #{version} (#{version_code})"
    puts "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

    # Clean up release notes file if used
    notes_file = "fastlane/release_notes.txt"
    if File.exist?(notes_file)
      File.delete(notes_file)
      puts "Release notes file cleaned up"
    end
  end

  error do |lane, exception|
    puts "Error in lane #{lane}: #{exception.message}"
  end
end
