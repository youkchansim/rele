# Fastfile for Android
# Generated by android-fastlane-deploy
#
# Available lanes:
#   fastlane screenshots        - Capture screenshots for all locales
#   fastlane screenshots_ko     - Capture Korean screenshots only
#   fastlane screenshots_en     - Capture English screenshots only
#   fastlane add_titles         - Apply iOS-style frames to screenshots
#   fastlane internal           - Deploy to internal testing
#   fastlane beta               - Deploy to closed testing (beta)
#   fastlane release            - Deploy to production
#

default_platform(:android)

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# Configuration
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

PACKAGE_NAME = "{{PACKAGE_NAME}}"
EMULATOR_KO = "Screenshot_KO"
EMULATOR_EN = "Screenshot_EN"
ADB = "#{ENV['HOME']}/Library/Android/sdk/platform-tools/adb"
EMULATOR_CMD = "#{ENV['HOME']}/Library/Android/sdk/emulator/emulator"

platform :android do

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“¸ Screenshot Lanes
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  desc "Capture screenshots for all locales (Korean + English)"
  lane :screenshots do
    screenshots_ko
    screenshots_en
    add_titles
  end

  desc "Capture Korean screenshots"
  lane :screenshots_ko do
    capture_screenshots_for_locale(
      locale: "ko-KR",
      emulator: EMULATOR_KO
    )
  end

  desc "Capture English screenshots"
  lane :screenshots_en do
    capture_screenshots_for_locale(
      locale: "en-US",
      emulator: EMULATOR_EN
    )
  end

  desc "Apply iOS-style frames to screenshots"
  lane :add_titles do
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ–¼ï¸ Applying frames to screenshots"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    unless system("which magick > /dev/null 2>&1")
      UI.user_error!("ImageMagick required. Install with: brew install imagemagick")
    end

    sh("bash ../fastlane/screenshots/add_titles.sh")

    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… Frames applied!"
    puts "   Results: fastlane/screenshots/*/images/framed/"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸš€ Deployment Lanes
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  desc "Deploy to internal testing track"
  lane :internal do |options|
    build_and_upload(
      track: "internal",
      release_notes: options[:notes] || "Internal test build"
    )
  end

  desc "Deploy to beta (closed testing) track"
  lane :beta do |options|
    build_and_upload(
      track: "beta",
      release_notes: options[:notes] || "Beta test build"
    )
  end

  desc "Deploy to production"
  lane :release do |options|
    build_and_upload(
      track: "production",
      release_notes: options[:notes] || "Bug fixes and performance improvements."
    )
  end

  desc "Build release AAB without uploading"
  lane :build_only do
    gradle(
      task: "bundle",
      build_type: "Release"
    )
    puts "âœ… AAB built: app/build/outputs/bundle/release/"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“‹ Metadata Lanes
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  desc "Download metadata from Google Play"
  lane :sync_metadata do
    download_from_play_store(
      package_name: PACKAGE_NAME
    )
  end

  desc "Upload metadata to Google Play"
  lane :upload_metadata do
    upload_to_play_store(
      package_name: PACKAGE_NAME,
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false
    )
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # Helper Methods
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  private_lane :capture_screenshots_for_locale do |options|
    locale = options[:locale]
    emulator = options[:emulator]

    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¸ Capturing #{locale} screenshots"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # Build screenshot APKs
    puts "\nğŸ”¨ Building screenshot flavor APKs..."
    gradle(task: "assemble", flavor: "screenshot", build_type: "Debug")
    gradle(task: "assemble", flavor: "screenshot", build_type: "DebugAndroidTest")

    # Start emulator
    puts "\nğŸš€ Starting emulator: #{emulator}..."
    start_emulator(emulator: emulator)

    # Wait for emulator to be ready
    puts "â³ Waiting for emulator to boot..."
    sh("#{ADB} wait-for-device")
    sleep(10)

    # Install APKs
    puts "\nğŸ“¦ Installing APKs..."
    sh("#{ADB} install -r app/build/outputs/apk/screenshot/debug/app-screenshot-debug.apk")
    sh("#{ADB} install -r app/build/outputs/apk/androidTest/screenshot/debug/app-screenshot-debug-androidTest.apk")

    # Create output directory
    output_dir = "fastlane/screenshots/#{locale}/images/phoneScreenshots"
    sh("mkdir -p ../#{output_dir}")

    # Run screenshot tests
    puts "\nğŸ“¸ Running screenshot tests..."
    sh("#{ADB} shell am instrument -w -e class #{PACKAGE_NAME}.screenshot.ScreenshotTest #{PACKAGE_NAME}.test/androidx.test.runner.AndroidJUnitRunner")

    # Pull screenshots from device
    puts "\nğŸ“¥ Pulling screenshots from device..."
    pull_screenshots(locale: locale, output_dir: output_dir)

    # Stop emulator
    puts "\nğŸ›‘ Stopping emulator..."
    stop_emulator

    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… #{locale} screenshots captured!"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  private_lane :start_emulator do |options|
    emulator = options[:emulator]

    # Kill any existing emulators
    sh("#{ADB} emu kill") rescue nil
    sleep(2)

    # Start emulator in background
    spawn("#{EMULATOR_CMD} -avd #{emulator} -no-snapshot-load -no-audio -no-boot-anim &")
  end

  private_lane :stop_emulator do
    sh("#{ADB} emu kill") rescue nil
    sleep(2)
  end

  private_lane :pull_screenshots do |options|
    locale = options[:locale]
    output_dir = options[:output_dir]

    # Pull using run-as for permission
    screenshots = %w[01_home 02_timetable 03_profile]

    screenshots.each do |name|
      sh("#{ADB} shell \"run-as #{PACKAGE_NAME} cat /data/data/#{PACKAGE_NAME}/app_screengrab/#{locale}/images/screenshots/#{name}.png\" > ../#{output_dir}/#{name}.png") rescue nil
    end
  end

  private_lane :build_and_upload do |options|
    track = options[:track]
    release_notes = options[:release_notes]

    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸš€ Deploying to #{track}"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # Increment version code
    increment_version_code

    # Build release AAB
    gradle(
      task: "bundle",
      build_type: "Release"
    )

    # Upload to Play Store
    upload_to_play_store(
      package_name: PACKAGE_NAME,
      track: track,
      aab: "app/build/outputs/bundle/release/app-release.aab",
      release_status: "completed",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true
    )

    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… Successfully deployed to #{track}!"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  private_lane :increment_version_code do
    # Read current version code from build.gradle
    gradle_file = "../app/build.gradle"

    if File.exist?(gradle_file)
      content = File.read(gradle_file)
      current_code = content.match(/versionCode\s+(\d+)/)[1].to_i
      new_code = current_code + 1

      new_content = content.gsub(/versionCode\s+\d+/, "versionCode #{new_code}")
      File.write(gradle_file, new_content)

      puts "ğŸ“ˆ Version code: #{current_code} â†’ #{new_code}"
    end
  end

  error do |lane, exception|
    puts "âŒ Error in lane #{lane}: #{exception.message}"
  end
end
