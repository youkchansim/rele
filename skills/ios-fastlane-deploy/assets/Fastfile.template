# Fastfile Template for iOS App Store Deployment
# λ²„μ „ ν•μ‹: MAJOR.YEAR.MMDDNNN (ChatGPT μ¤νƒ€μΌ)
#
# μ‚¬μ©λ²•:
#   1. μ΄ νμΌμ„ ν”„λ΅μ νΈμ fastlane/Fastfileλ΅ λ³µμ‚¬
#   2. PROJECT, SCHEME, MAJOR_VERSION μμ •
#   3. API ν‚¤ μ •λ³΄ μ…λ ¥ (key_id, issuer_id, key_filepath)
#
# λ…λ Ήμ–΄:
#   fastlane release                    - App Store λ°°ν¬ (κΈ°λ³Έ λ¦΄λ¦¬μ¦λ…ΈνΈ)
#   fastlane release notes:"μ»¤μ¤ν…€ λ…ΈνΈ" - App Store λ°°ν¬ (μ»¤μ¤ν…€ λ¦΄λ¦¬μ¦λ…ΈνΈ)
#   fastlane beta                       - TestFlight λ°°ν¬
#   fastlane build_only                 - λΉλ“λ§
#
# λ¦΄λ¦¬μ¦λ…ΈνΈ μµμ…:
#   1. νλΌλ―Έν„° μ—†μ: κΈ°λ³Έκ°’ μ‚¬μ© ("μ•μ •μ„±μ„ κ°μ„ ν•μ€μ–΄μ”")
#   2. notes:"ν…μ¤νΈ": μ§μ ‘ μ§€μ •
#   3. fastlane/release_notes.txt νμΌμ΄ μμΌλ©΄ ν•΄λ‹Ή λ‚΄μ© μ‚¬μ©

default_platform(:ios)

platform :ios do

  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  # π”§ ν”„λ΅μ νΈ μ„¤μ • (μμ • ν•„μ”)
  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  PROJECT = "YourApp.xcodeproj"     # Xcode ν”„λ΅μ νΈ νμΌλ…
  SCHEME = "YourApp"                 # λΉλ“ Scheme μ΄λ¦„
  BUNDLE_ID = "com.yourcompany.app"  # Bundle Identifier
  MAJOR_VERSION = "1"                # λ©”μ΄μ € λ²„μ „ (ν° λ³€κ²½ μ‹ μλ™ μ¦κ°€)

  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  # π” App Store Connect API ν‚¤ μ„¤μ •
  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  # κ³µμ© ν‚¤ μ„μΉ: ~/.appstore_keys/
  # ν”„λ΅μ νΈλ³„ ν‚¤κ°€ ν•„μ”ν•λ©΄ fastlane/AuthKey_*.p8 μ‚¬μ©

  GLOBAL_CONFIG_DIR = File.expand_path("~/.appstore_keys")
  GLOBAL_CONFIG_PATH = "#{GLOBAL_CONFIG_DIR}/config.json"

  # κ³µμ© μ„¤μ • λ΅λ“
  def load_global_config
    if File.exist?(GLOBAL_CONFIG_PATH)
      require 'json'
      JSON.parse(File.read(GLOBAL_CONFIG_PATH))
    else
      nil
    end
  end

  # API ν‚¤ κ²½λ΅ κ²°μ • (ν”„λ΅μ νΈ λ΅μ»¬ β†’ κ³µμ© μ„μΉ)
  def find_api_key_path(config)
    local_key = Dir.glob("fastlane/AuthKey_*.p8").first
    return local_key if local_key

    if config && config.dig("default", "key_file")
      global_key = "#{GLOBAL_CONFIG_DIR}/#{config.dig("default", "key_file")}"
      return global_key if File.exist?(global_key)
    end

    nil
  end

  # μ„¤μ • κ²€μ¦ λ° μ—λ¬ ν‘μ‹
  def validate_api_config!
    config = load_global_config
    key_path = find_api_key_path(config)

    if config.nil? || key_path.nil?
      puts ""
      puts "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
      puts "β App Store Connect API ν‚¤κ°€ μ„¤μ •λμ§€ μ•μ•μµλ‹λ‹¤!"
      puts "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
      puts ""
      puts "π“ μ„¤μ • λ°©λ²•:"
      puts ""
      puts "1. λ””λ ‰ν† λ¦¬ μƒμ„±:"
      puts "   mkdir -p ~/.appstore_keys"
      puts ""
      puts "2. API ν‚¤ νμΌ λ³µμ‚¬ (.p8 νμΌ):"
      puts "   cp /path/to/AuthKey_XXXXXX.p8 ~/.appstore_keys/"
      puts ""
      puts "3. config.json μƒμ„±:"
      puts "   cat > ~/.appstore_keys/config.json << 'EOF'"
      puts '   {'
      puts '     "default": {'
      puts '       "key_id": "YOUR_KEY_ID",'
      puts '       "issuer_id": "YOUR_ISSUER_ID",'
      puts '       "key_file": "AuthKey_XXXXXX.p8"'
      puts '     },'
      puts '     "apple_id": "your-email@example.com",'
      puts '     "team_id": "XXXXXXXXXX"'
      puts '   }'
      puts "   EOF"
      puts ""
      puts "π“ API ν‚¤ λ°κΈ‰ λ°©λ²•:"
      puts "   1. https://appstoreconnect.apple.com μ ‘μ†"
      puts "   2. Users and Access β†’ Keys β†’ App Store Connect API"
      puts "   3. + λ²„νΌμΌλ΅ μƒ ν‚¤ μƒμ„± (Admin κ¶ν•)"
      puts "   4. Key ID, Issuer ID λ³µμ‚¬"
      puts "   5. .p8 νμΌ λ‹¤μ΄λ΅λ“"
      puts ""
      puts "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
      UI.user_error!("API ν‚¤ μ„¤μ •μ΄ ν•„μ”ν•©λ‹λ‹¤. μ„ κ°€μ΄λ“λ¥Ό μ°Έκ³ ν•μ„Έμ”.")
    end

    { config: config, key_path: key_path }
  end

  # μ„¤μ • κ²€μ¦
  API_CONFIG = validate_api_config!
  GLOBAL_CONFIG = API_CONFIG[:config]

  API_KEY = app_store_connect_api_key(
    key_id: GLOBAL_CONFIG.dig("default", "key_id"),
    issuer_id: GLOBAL_CONFIG.dig("default", "issuer_id"),
    key_filepath: API_CONFIG[:key_path]
  )

  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  # π“ λ²„μ „ μλ™ μƒμ„± (ChatGPT μ¤νƒ€μΌ: MAJOR.YEAR.MMDDNNN)
  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  desc "μλ™ λ²„μ „ μƒμ„±"
  private_lane :generate_version do
    now = Time.now
    year = now.strftime("%Y")
    mmdd = now.strftime("%m%d")

    current_version = get_version_number(
      xcodeproj: PROJECT,
      target: SCHEME
    )

    today_pattern = "#{MAJOR_VERSION}.#{year}.#{mmdd}"

    if current_version.start_with?(today_pattern)
      last_three = current_version[-3..-1].to_i
      serial = format("%03d", last_three + 1)
    else
      serial = "001"
    end

    new_version = "#{today_pattern}#{serial}"
    new_build = "#{year}#{mmdd}#{serial}"

    { version: new_version, build: new_build }
  end

  desc "λ²„μ „ μ—…λ°μ΄νΈ μ μ©"
  private_lane :apply_version do |options|
    version_info = options[:version_info]

    increment_version_number(
      xcodeproj: PROJECT,
      version_number: version_info[:version]
    )

    increment_build_number(
      xcodeproj: PROJECT,
      build_number: version_info[:build]
    )

    puts "π“ λ²„μ „ μ—…λ°μ΄νΈ: #{version_info[:version]} (#{version_info[:build]})"
  end

  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  # π“ λ¦΄λ¦¬μ¦λ…ΈνΈ μƒμ„±
  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  # μ°μ„ μμ„:
  #   1. νλΌλ―Έν„°λ΅ μ „λ‹¬λ notes
  #   2. fastlane/release_notes.txt νμΌ
  #   3. κΈ°λ³Έκ°’
  desc "λ¦΄λ¦¬μ¦λ…ΈνΈ κ°€μ Έμ¤κΈ°"
  private_lane :get_release_notes do |options|
    custom_notes = options[:notes]
    notes_file = "fastlane/release_notes.txt"

    # κΈ°λ³Έ λ¦΄λ¦¬μ¦λ…ΈνΈ
    default_notes = {
      "en-US" => "Improved stability and performance.",
      "ko" => "μ•μ •μ„±μ„ κ°μ„ ν•μ€μ–΄μ”."
    }

    if custom_notes && !custom_notes.empty?
      # 1. νλΌλ―Έν„°λ΅ μ „λ‹¬λ λ…ΈνΈ μ‚¬μ©
      puts "π“ λ¦΄λ¦¬μ¦λ…ΈνΈ: μ»¤μ¤ν…€ (νλΌλ―Έν„°)"
      {
        "default" => custom_notes,
        "en-US" => custom_notes,
        "ko" => custom_notes
      }
    elsif File.exist?(notes_file)
      # 2. νμΌμ—μ„ μ½κΈ°
      content = File.read(notes_file).strip
      puts "π“ λ¦΄λ¦¬μ¦λ…ΈνΈ: νμΌ (#{notes_file})"

      # νμΌ ν•μ‹ νμ‹± (μ–Έμ–΄λ³„ κµ¬λ¶„ μ§€μ›)
      # ν•μ‹:
      # [ko]
      # ν•κµ­μ–΄ λ…ΈνΈ
      # [en-US]
      # English notes
      if content.include?("[ko]") || content.include?("[en-US]")
        notes = { "default" => "" }
        current_lang = "default"

        content.each_line do |line|
          line = line.strip
          if line.match(/^\[(.+)\]$/)
            current_lang = $1
            notes[current_lang] ||= ""
          elsif !line.empty?
            notes[current_lang] += (notes[current_lang].empty? ? "" : "\n") + line
          end
        end

        notes["default"] = notes["ko"] || notes["en-US"] || content
        notes
      else
        # λ‹¨μΌ μ–Έμ–΄ (ν•κµ­μ–΄λ΅ κ°„μ£Ό)
        {
          "default" => content,
          "en-US" => content,
          "ko" => content
        }
      end
    else
      # 3. κΈ°λ³Έκ°’ μ‚¬μ©
      puts "π“ λ¦΄λ¦¬μ¦λ…ΈνΈ: κΈ°λ³Έκ°’"
      {
        "default" => default_notes["ko"],
        "en-US" => default_notes["en-US"],
        "ko" => default_notes["ko"]
      }
    end
  end

  before_all do
    # Git μƒνƒ ν™•μΈ (ν•„μ” μ‹ ν™μ„±ν™”)
    # ensure_git_status_clean
  end

  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  # π€ App Store λ°°ν¬
  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  desc "App Store λ°°ν¬ (μ‹¬μ‚¬ μ μ¶ ν¬ν•¨)"
  desc "μ‚¬μ©λ²•: fastlane release [notes:'λ¦΄λ¦¬μ¦λ…ΈνΈ']"
  lane :release do |options|
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    # λ¦΄λ¦¬μ¦λ…ΈνΈ κ°€μ Έμ¤κΈ°
    release_notes = get_release_notes(notes: options[:notes])

    puts "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
    puts "π“¦ App Store λ°°ν¬ μ‹μ‘"
    puts "   λ²„μ „: #{version}"
    puts "   λΉλ“: #{build_number}"
    puts "   λ¦΄λ¦¬μ¦λ…ΈνΈ (ko): #{release_notes['ko']&.slice(0, 50)}..."
    puts "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    puts "β… λΉλ“ μ™„λ£: ./build/#{SCHEME}.ipa"

    upload_to_app_store(
      api_key: API_KEY,
      skip_metadata: true,
      skip_screenshots: true,
      skip_binary_upload: false,
      force: true,
      submit_for_review: true,
      automatic_release: true,
      submission_information: {
        add_id_info_uses_idfa: false
      },
      release_notes: release_notes
    )

    puts "\nβ”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
    puts "β… App Store λ°°ν¬ μ™„λ£!"
    puts "   λ²„μ „: #{version} (#{build_number})"
    puts "   μƒνƒ: μ‹¬μ‚¬ λ€κΈ° μ¤‘"
    puts "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"

    # λ¦΄λ¦¬μ¦λ…ΈνΈ νμΌ μ •λ¦¬ (μ‚¬μ© ν›„ μ‚­μ )
    notes_file = "fastlane/release_notes.txt"
    if File.exist?(notes_file)
      File.delete(notes_file)
      puts "π—‘οΈ  λ¦΄λ¦¬μ¦λ…ΈνΈ νμΌ μ‚­μ λ¨"
    end
  end

  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  # π§ TestFlight λ² νƒ€ λ°°ν¬
  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  desc "TestFlight λ² νƒ€ λ°°ν¬"
  desc "μ‚¬μ©λ²•: fastlane beta"
  lane :beta do
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    puts "π§ TestFlight λ°°ν¬: #{version} (#{build_number})"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    upload_to_testflight(
      api_key: API_KEY,
      skip_waiting_for_build_processing: true
    )

    puts "β… TestFlight μ—…λ΅λ“ μ™„λ£!"
  end

  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  # π“¥ λ©”νƒ€λ°μ΄ν„° λ™κΈ°ν™”
  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  desc "App Store Connectμ—μ„ λ©”νƒ€λ°μ΄ν„° λ‹¤μ΄λ΅λ“"
  desc "μ‚¬μ©λ²•: fastlane sync_metadata"
  lane :sync_metadata do
    puts "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
    puts "π“¥ λ©”νƒ€λ°μ΄ν„° λ™κΈ°ν™” μ‹μ‘"
    puts "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"

    # λ©”νƒ€λ°μ΄ν„° λ‹¤μ΄λ΅λ“ (μ•± μ„¤λ…, ν‚¤μ›λ“, What's New λ“±)
    puts "\nπ“ λ©”νƒ€λ°μ΄ν„° λ‹¤μ΄λ΅λ“ μ¤‘..."
    download_metadata(
      api_key: API_KEY,
      app_identifier: BUNDLE_ID
    )

    # μ¤ν¬λ¦°μƒ· λ‹¤μ΄λ΅λ“
    puts "\nπ“Έ μ¤ν¬λ¦°μƒ· λ‹¤μ΄λ΅λ“ μ¤‘..."
    download_screenshots(
      api_key: API_KEY,
      app_identifier: BUNDLE_ID
    )

    puts "\nβ”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
    puts "β… λ©”νƒ€λ°μ΄ν„° λ™κΈ°ν™” μ™„λ£!"
    puts "   - fastlane/metadata/"
    puts "   - fastlane/screenshots/"
    puts "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
  end

  desc "λ©”νƒ€λ°μ΄ν„°λ¥Ό App Store Connectμ— μ—…λ΅λ“ (λ°”μ΄λ„λ¦¬ μ—†μ΄)"
  desc "μ‚¬μ©λ²•: fastlane upload_metadata"
  lane :upload_metadata do
    puts "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
    puts "π“¤ λ©”νƒ€λ°μ΄ν„° μ—…λ΅λ“ μ‹μ‘"
    puts "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"

    upload_to_app_store(
      api_key: API_KEY,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true
    )

    puts "\nβ”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
    puts "β… λ©”νƒ€λ°μ΄ν„° μ—…λ΅λ“ μ™„λ£!"
    puts "β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”"
  end

  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  # π”¨ λΉλ“λ§ (μ—…λ΅λ“ μ—†μ΄)
  # β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”β”
  desc "λΉλ“λ§ μν–‰ (μ—…λ΅λ“ μ—†μ΄)"
  desc "μ‚¬μ©λ²•: fastlane build_only"
  lane :build_only do
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    puts "π”¨ λΉλ“λ§ μν–‰: #{version} (#{build_number})"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    puts "β… λΉλ“ μ™„λ£: ./build/#{SCHEME}.ipa"
  end

  error do |lane, exception|
    puts "β μ—λ¬ λ°μƒ: #{exception.message}"
  end
end
