# Fastfile Template for iOS App Store Deployment
# ë²„ì „ í˜•ì‹: MAJOR.YEAR.MMDDNNN (ChatGPT ìŠ¤íƒ€ì¼)
#
# ì‚¬ìš©ë²•:
#   1. ì´ íŒŒì¼ì„ í”„ë¡œì íŠ¸ì˜ fastlane/Fastfileë¡œ ë³µì‚¬
#   2. PROJECT, SCHEME, MAJOR_VERSION ìˆ˜ì •
#   3. API í‚¤ ì •ë³´ ì…ë ¥ (key_id, issuer_id, key_filepath)
#
# ëª…ë ¹ì–´:
#   fastlane release    - App Store ë°°í¬
#   fastlane beta       - TestFlight ë°°í¬
#   fastlane build_only - ë¹Œë“œë§Œ

default_platform(:ios)

platform :ios do

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ”§ í”„ë¡œì íŠ¸ ì„¤ì • (ìˆ˜ì • í•„ìš”)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  PROJECT = "YourApp.xcodeproj"     # Xcode í”„ë¡œì íŠ¸ íŒŒì¼ëª…
  SCHEME = "YourApp"                 # ë¹Œë“œ Scheme ì´ë¦„
  BUNDLE_ID = "com.yourcompany.app"  # Bundle Identifier
  MAJOR_VERSION = "1"                # ë©”ì´ì € ë²„ì „ (í° ë³€ê²½ ì‹œ ìˆ˜ë™ ì¦ê°€)

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ” App Store Connect API í‚¤ ì„¤ì •
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  API_KEY = app_store_connect_api_key(
    key_id: "YOUR_KEY_ID",                      # API Key ID
    issuer_id: "YOUR_ISSUER_ID",                # Issuer ID
    key_filepath: "fastlane/AuthKey_XXXXX.p8"   # .p8 íŒŒì¼ ê²½ë¡œ
  )

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“Œ ë²„ì „ ìë™ ìƒì„± (ChatGPT ìŠ¤íƒ€ì¼: MAJOR.YEAR.MMDDNNN)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "ìë™ ë²„ì „ ìƒì„±"
  private_lane :generate_version do
    now = Time.now
    year = now.strftime("%Y")
    mmdd = now.strftime("%m%d")

    current_version = get_version_number(
      xcodeproj: PROJECT,
      target: SCHEME
    )

    today_pattern = "#{MAJOR_VERSION}.#{year}.#{mmdd}"

    if current_version.start_with?(today_pattern)
      last_three = current_version[-3..-1].to_i
      serial = format("%03d", last_three + 1)
    else
      serial = "001"
    end

    new_version = "#{today_pattern}#{serial}"
    new_build = "#{year}#{mmdd}#{serial}"

    { version: new_version, build: new_build }
  end

  desc "ë²„ì „ ì—…ë°ì´íŠ¸ ì ìš©"
  private_lane :apply_version do |options|
    version_info = options[:version_info]

    increment_version_number(
      xcodeproj: PROJECT,
      version_number: version_info[:version]
    )

    increment_build_number(
      xcodeproj: PROJECT,
      build_number: version_info[:build]
    )

    puts "ğŸ“Œ ë²„ì „ ì—…ë°ì´íŠ¸: #{version_info[:version]} (#{version_info[:build]})"
  end

  before_all do
    # Git ìƒíƒœ í™•ì¸ (í•„ìš” ì‹œ í™œì„±í™”)
    # ensure_git_status_clean
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸš€ App Store ë°°í¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "App Store ë°°í¬ (ì‹¬ì‚¬ ì œì¶œ í¬í•¨)"
  desc "ì‚¬ìš©ë²•: fastlane release"
  lane :release do
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¦ App Store ë°°í¬ ì‹œì‘"
    puts "   ë²„ì „: #{version}"
    puts "   ë¹Œë“œ: #{build_number}"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    puts "âœ… ë¹Œë“œ ì™„ë£Œ: ./build/#{SCHEME}.ipa"

    upload_to_app_store(
      api_key: API_KEY,
      skip_metadata: true,
      skip_screenshots: true,
      skip_binary_upload: false,
      force: true,
      submit_for_review: true,
      automatic_release: true,
      submission_information: {
        add_id_info_uses_idfa: false
      },
      release_notes: {
        "default" => "Bug fixes and performance improvements.",
        "en-US" => "Bug fixes and performance improvements.",
        "ko" => "ë²„ê·¸ ìˆ˜ì • ë° ì„±ëŠ¥ì„ ê°œì„ í–ˆì–´ìš”!"
      }
    )

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… App Store ë°°í¬ ì™„ë£Œ!"
    puts "   ë²„ì „: #{version} (#{build_number})"
    puts "   ìƒíƒœ: ì‹¬ì‚¬ ëŒ€ê¸° ì¤‘"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ§ª TestFlight ë² íƒ€ ë°°í¬
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "TestFlight ë² íƒ€ ë°°í¬"
  desc "ì‚¬ìš©ë²•: fastlane beta"
  lane :beta do
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    puts "ğŸ§ª TestFlight ë°°í¬: #{version} (#{build_number})"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    upload_to_testflight(
      api_key: API_KEY,
      skip_waiting_for_build_processing: true
    )

    puts "âœ… TestFlight ì—…ë¡œë“œ ì™„ë£Œ!"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ“¥ ë©”íƒ€ë°ì´í„° ë™ê¸°í™”
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "App Store Connectì—ì„œ ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ"
  desc "ì‚¬ìš©ë²•: fastlane sync_metadata"
  lane :sync_metadata do
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¥ ë©”íƒ€ë°ì´í„° ë™ê¸°í™” ì‹œì‘"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ (ì•± ì„¤ëª…, í‚¤ì›Œë“œ, What's New ë“±)
    puts "\nğŸ“ ë©”íƒ€ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘..."
    download_metadata(
      api_key: API_KEY,
      app_identifier: BUNDLE_ID
    )

    # ìŠ¤í¬ë¦°ìƒ· ë‹¤ìš´ë¡œë“œ
    puts "\nğŸ“¸ ìŠ¤í¬ë¦°ìƒ· ë‹¤ìš´ë¡œë“œ ì¤‘..."
    download_screenshots(
      api_key: API_KEY,
      app_identifier: BUNDLE_ID
    )

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… ë©”íƒ€ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ!"
    puts "   - fastlane/metadata/"
    puts "   - fastlane/screenshots/"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  desc "ë©”íƒ€ë°ì´í„°ë¥¼ App Store Connectì— ì—…ë¡œë“œ (ë°”ì´ë„ˆë¦¬ ì—†ì´)"
  desc "ì‚¬ìš©ë²•: fastlane upload_metadata"
  lane :upload_metadata do
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "ğŸ“¤ ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì‹œì‘"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    upload_to_app_store(
      api_key: API_KEY,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true
    )

    puts "\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    puts "âœ… ë©”íƒ€ë°ì´í„° ì—…ë¡œë“œ ì™„ë£Œ!"
    puts "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  end

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # ğŸ”¨ ë¹Œë“œë§Œ (ì—…ë¡œë“œ ì—†ì´)
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  desc "ë¹Œë“œë§Œ ìˆ˜í–‰ (ì—…ë¡œë“œ ì—†ì´)"
  desc "ì‚¬ìš©ë²•: fastlane build_only"
  lane :build_only do
    version_info = generate_version
    apply_version(version_info: version_info)

    version = version_info[:version]
    build_number = version_info[:build]

    puts "ğŸ”¨ ë¹Œë“œë§Œ ìˆ˜í–‰: #{version} (#{build_number})"

    build_app(
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: "fastlane/ExportOptions.plist",
      output_directory: "./build",
      output_name: "#{SCHEME}.ipa",
      clean: true,
      include_symbols: true,
      xcargs: "-allowProvisioningUpdates"
    )

    puts "âœ… ë¹Œë“œ ì™„ë£Œ: ./build/#{SCHEME}.ipa"
  end

  error do |lane, exception|
    puts "âŒ ì—ëŸ¬ ë°œìƒ: #{exception.message}"
  end
end
